!function(){try{var e="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{},n=(new e.Error).stack;n&&(e._sentryDebugIds=e._sentryDebugIds||{},e._sentryDebugIds[n]="cc0e4a37-4064-3507-8dad-6fcca280fa7f")}catch(e){}}();
define(["exports","./c_flux_base_store","./e_ui_page_files_router","./c_bem","./c_lodash-es_lodash","./c_flux_dispatcher","./c_ncct_manual_assist_util","./c_react_query_api_helpers_queries_seen_state_info","./e_core_exception","react","./c_sharing_settings_utils_link_metadata_types","./c_src_bindings_api-context","./e_data_modules_stormcrow","./c_flux_action_type","./c_pap-events_folder_modal_select_create_folder_modal_create_button","./c_core_i18n","./c_sharing_ui_util"],(function(e,t,s,n,i,a,r,o,c,_,h,d,l,u,E,S,p){"use strict";function m(e){if(e&&e.__esModule)return e;var t=Object.create(null);return e&&Object.keys(e).forEach((function(s){if("default"!==s){var n=Object.getOwnPropertyDescriptor(e,s);Object.defineProperty(t,s,n.get?n:{enumerable:!0,get:function(){return e[s]}})}})),t.default=e,Object.freeze(t)}var f=m(_);const I=5e3,C=256,g="-",T={WEB:0,IOS:1,ANDROID:2,DESKTOP:3};class A{constructor(e,t,s=void 0){this.platform=e,this.surface=t,this.identifier=null!=s?s:"";let n=!1;for(const e in T){const t=T[e];if(this.platform===t){n=!0;break}}if(!n)throw new Error("platform must be from Beacon.Platforms");if(this.surface.length>32||0===this.surface.length)throw new Error("surface must be populated and <= 32 chars.");if(this.identifier.length>128)throw new Error("identifier must be <= 128 chars.")}static from_json(e){return new A(e.platform,e.surface,e.identifier)}}class N{constructor(e,t,s,n){if(this.user_id=e,this.app=t,this.context=s,this.source=n,this.user_id.length>C)throw new Error("user_id must be <= 256 chars.");if(this.app.length>32||0===this.app.length)throw new Error("app must be populated and <= 32 chars.");if(this.context.length>64||0===this.context.length)throw new Error("context must be populated and <= 64 chars.")}static from_json(e){const t=A.from_json(e.source);return new N(e.user_id,e.app,e.context,t)}}class R{constructor(e,t,s){if(this.agent=e,this.status=t,this.auth_key=s,this.status.length>32)throw new Error("status must be <= 32 chars")}static from_json(e){return new R(N.from_json(e.agent),e.status)}}const P="UserContext",M="UserApp",L="Context";class O{constructor(e,t,s,n,i){if(this.type=e,this.user_id=t,this.app=s,this.context=n,this.token=i,this.type!==P&&this.type!==M&&this.type!==L)throw new Error(`Unsupported type: ${this.type}.`);if((null!=this.user_id?this.user_id.length:0)>C)throw new Error("user_id must be <= 256 chars.");if(this.app.length>32)throw new Error("app must be <= 32 chars.");if((null!=this.context?this.context.length:0)>64)throw new Error("context must be <= 64 chars.")}}class b{constructor(e,t){this.presence_params=e,this.agents=t}}class F{constructor(e,t){this.presence_params=e,this.status=t}}F.Status={Offline:1,Online:2};class U{constructor(e,t,s){this.presence_params=e,this.snapshot=t,this.delta=s}}class D{constructor(e,t,s,n=(()=>{})){this._backoff_window=I,this._heartbeat=()=>{if(!this._started||0===this._presence_data.length)return;this._offline_agents=this._presence_data.filter((e=>""!==e.status)).map((e=>e.agent)),this._has_changes=!1;const e=new AbortController;this._heartbeat_xhr=fetch(`https://${this.beaconUrl}/1/update`,{method:"POST",body:JSON.stringify({token:this._token,updates:this._presence_data}),headers:{"Content-Type":"application/json; charset=utf-8"},credentials:"include",signal:e.signal}).then((e=>e.json())).then(this._handle_heartbeat_success).catch(this._handle_heartbeat_error),setTimeout((()=>e.abort()),5e3)},this._handle_heartbeat_success=e=>{if(this._heartbeat_xhr=void 0,!this._started)return;const t=[];for(const s of e.agent_errors||[]){const e=s.error,n=N.from_json(s.agent);if("authorization_error"===e)t.push(n);else if("invalid_agent"===e)throw new Error(`Input error: ${s}`);this._presence_data=this._presence_data.filter((e=>!i.lodashExports.isEqual(e.agent,n)))}if(t.length){const e=this._authz_cb;window.setTimeout((()=>e(t)),0)}for(const e of this._offline_agents)for(let t=0;t<this._presence_data.length;t++){const s=this._presence_data[t];if(i.lodashExports.isEqual(s.agent,e)&&""===s.status){this._presence_data.splice(t,1);break}}const s=this._has_changes?0:6e4;this._backoff_window=I,this._timeout_id=window.setTimeout(this._heartbeat,s)},this._handle_heartbeat_error=e=>{if(this._heartbeat_xhr=void 0,!this._started)return;if(e.status>=400&&e.status<500&&401===e.status)return window.setTimeout(this._authn_cb,0),void this.stop();const t=Math.random()*this._backoff_window;this._backoff_window=Math.min(2*this._backoff_window,12e4),this._timeout_id=window.setTimeout(this._heartbeat,t)},this._token=e,this._authn_cb=s,this._authz_cb=n,this._started=!1,this._presence_data=[],this._offline_agents=[],this._has_changes=!1,this.beaconUrl=t}start(){if(!this._started)return this._backoff_window=I,this._started=!0,this._has_changes=!1,this._heartbeat()}stop(){this._started=!1,this._heartbeat_xhr=void 0,window.clearTimeout(this._timeout_id),this._timeout_id=void 0}add_or_update_agents(e){for(const t of e)this._has_changes=this._add_or_update_agent(t)||this._has_changes;!this._heartbeat_xhr&&this._started&&(window.clearTimeout(this._timeout_id),this._timeout_id=window.setTimeout(this._heartbeat,0))}_add_or_update_agent(e){for(let t=0;t<this._presence_data.length;t++){const s=this._presence_data[t];if(i.lodashExports.isEqual(s.agent,e.agent))return(s.status!==e.status||s.auth_key!==e.auth_key)&&(this._presence_data[t]=e,!0)}return this._presence_data.push(e),!0}}class k{constructor(e,t,n,a){this._compact_context_updates=(e,t)=>{let s,n,a=!1,r=[];for(const e of t)if(null!=e.snapshot)a=!0,r=e.snapshot;else if(null!=e.delta)for(const t of e.delta){let e=!1;for(let s=0;s<r.length;s++){const n=r[s];if(i.lodashExports.isEqual(n.agent,t.agent)){e=!0,r[s]=t;break}}e||r.push(t)}return a?(n=r,s=void 0):(n=void 0,s=r),new U(e,n,s)},this._on_update=e=>{const t=[];for(const n of e){const{channel_state:e}=n,i=new s.ChannelId(e.app_id,e.unique_id),a=this._bolt_channel_to_presence_params(i);switch(a.type){case P:{const{payload:e}=n.payloads.slice(-1)[0],s=null!=e.agents?e.agents.map(R.from_json):[];t.push(new b(a,s));break}case M:{const{payload:e}=n.payloads.slice(-1)[0];t.push(new F(a,e.status));break}case L:{const e=function(e){const t=A.from_json(e.source),s=new N(e.user_id,a.app,a.context,t);return new R(s,e.status)},s=function(t){var s,n,i,a;return{snapshot:null===(n=null===(s=t.snapshot)||void 0===s?void 0:s.agents)||void 0===n?void 0:n.map(e),delta:null===(a=null===(i=t.delta)||void 0===i?void 0:i.agents)||void 0===a?void 0:a.map(e)}},i=n.payloads.map((e=>s(e.payload)));t.push(this._compact_context_updates(a,i));break}}}return this._update_callback(t)},this._on_refresh=e=>this._refresh_callback(e.map(this._bolt_channel_to_presence_params)),this._presence_params=e,this._update_callback=t,this._refresh_callback=n;const r=this._presence_params.map(this._presence_params_to_bolt_channel);this._thunder_client=new s.ThunderClient(r,this._on_update,this._on_refresh,a)}start(){return this._thunder_client.start()}stop(){return this._thunder_client.unsubscribe()}_presence_params_to_bolt_channel(e){switch(e.type){case P:return new s.SignedChannelState(`beacon_uc${g}${e.app}`,`${e.user_id}|${e.context}`,"0",e.token);case M:return new s.SignedChannelState(`beacon_ua${g}${e.app}`,e.user_id||"","0",e.token);case L:return new s.SignedChannelState(`beacon_c${g}${e.app}`,e.context,"0",e.token);default:throw new Error(`Unknown type: ${e.type}`)}}_bolt_channel_to_presence_params(e){const t=e.app_id.split(g),s=e.unique_id.split("|");if(2!==t.length)throw new Error(`Unexpected format of Bolt app_id: ${e.app_id}.`);const n=t[1];let i="",a="",r=P;switch(t[0]){case"beacon_uc":if(2!==s.length)throw new Error(`Unexpected format of beacon_uc: ${e.unique_id}.`);r=P,i=s[0],a=s[1];break;case"beacon_ua":if(1!==s.length)throw new Error(`Unexpected format of beacon_ua: ${e.unique_id}.`);r=M,i=s[0];break;case"beacon_c":if(1!==s.length)throw new Error(`Unexpected format of beacon_c: ${e.unique_id}.`);r=L,a=s[0];break;default:throw new Error(`Unknown Bolt app_id: ${e.app_id}.`)}return new O(r,i,n,a,void 0)}}class y{static passPermissionRequest(e){a.dispatcherSingleton.dispatch({type:s.ActionTypes$3.PASS_PERMISSION_REQUEST,data:{fileId:e}})}static updatePermissions(e,t){a.dispatcherSingleton.dispatch({type:s.ActionTypes$3.UPDATE_PERMISSIONS,data:{fileId:e,partialPermission:t}})}static fetchPassError(e){a.dispatcherSingleton.dispatch({type:s.ActionTypes$3.FETCH_PASS_ERROR,data:{fileId:e}})}static fetchPassConcluded(e){a.dispatcherSingleton.dispatch({type:s.ActionTypes$3.FETCH_PASS_CONCLUDED,data:{fileId:e}})}static receivePresenceDelta(e,t,n,i){a.dispatcherSingleton.dispatch({type:s.ActionTypes$3.RECEIVE_PRESENCE_DELTA,data:{userId:e,fileId:t,onlineUniqueUsers:n,offlineUniqueUsers:i}})}static receivePresenceSnapshot(e,t,n){a.dispatcherSingleton.dispatch({type:s.ActionTypes$3.RECEIVE_PRESENCE_SNAPSHOT,data:{userId:e,fileId:t,onlineUniqueUsers:n}})}static resetPassInfo(e){a.dispatcherSingleton.dispatch({type:s.ActionTypes$3.RESET_PASS_INFO,data:{fileId:e}})}static updateSeenStateInfo(e,t,n){a.dispatcherSingleton.dispatch({type:s.ActionTypes$3.UPDATE_SEEN_STATE_INFO,data:{fileId:e,seenStateInfo:t,seenStateCursor:n}})}static updateSeenStateInfoContinue(e,t,n){a.dispatcherSingleton.dispatch({type:s.ActionTypes$3.UPDATE_SEEN_STATE_INFO_CONTINUE,data:{fileId:e,seenStateInfo:t,seenStateCursor:n}})}static discontinueSeenStateInfo(e){a.dispatcherSingleton.dispatch({type:s.ActionTypes$3.DISCONTINUE_SEEN_STATE_INFO,data:{fileId:e}})}static updateSeenStateUnavailable(e,t){a.dispatcherSingleton.dispatch({type:s.ActionTypes$3.UPDATE_SEEN_STATE_UNAVAILABLE,data:{userId:e,fileId:t}})}}const w=[s.LoggingActions.PRESENCE_RECEIVE,s.LoggingActions.TRANSMITTER_TOKEN_BEGIN,s.LoggingActions.TRANSMITTER_TOKEN_RECEIVE,s.LoggingActions.RECEIVER_TOKEN_BEGIN,s.LoggingActions.RECEIVER_TOKEN_RECEIVE,s.LoggingActions.SEEN_STATE_USERS_BEGIN,s.LoggingActions.SEEN_STATE_USERS_RECEIVE];const v=new class{constructor(){this.allTimestamps={}}record(e,t){const s=(new Date).getTime()/1e3;this.allTimestamps[t]=this.allTimestamps[t]||{};const n=this.allTimestamps[t];n.hasOwnProperty(e)?this.reportStackForRepeatedAction(n,e,t,s):n[e]=s}get(e){return this.allTimestamps[e]||{}}reportStackForRepeatedAction(e,t,s,n){if(w.indexOf(t)>=0)return;const i=e[t];c.reportStack("Attempted to record action for which there existed a previous record",{severity:c.SEVERITY.NONCRITICAL,tags:["pass:actionTimestampsTracker"],exc_extra:{pass_session_id:s,action:t,oldTimestamp:i,newTimestamp:n}})}};var H,B;function x(e){y.resetPassInfo(e),y.fetchPassError(e)}function q(e,t){return{file_identifier:e,shared_link_details:t?{url:t}:void 0}}!function(e){function t(e){return e.startsWith("dbafvid:")}e.isAnonymousUserId=t,e.isAnonymousSeenState=e=>t(e.seen_state_user.user_id)}(H||(H={})),function(e){e.create=function(e){return e?new s.FetchAsyncTransport:new s.FetchSyncTransport}}(B||(B={}));class V{static constructFakeSeenStateInfo(e,t,s){const n=s.seen_states,i=[];for(const e of n)i.push(e.seen_state_user.user_id);for(const s of e)if(!i.includes(s.user_id)){s.sharing_access_type&&(s.sharing_access_type=s.sharing_access_type);const e={seen_state_user:s,when_last_seen:t,seen_events:[]};n.unshift(e)}return s.seen_states=n,s}static parseSeenStatePassPlatform(e){switch(null==e?void 0:e[".tag"]){case"web":return s.PassPlatform.WEB;case"mobile":case"mobile_ios":case"mobile_android":return s.PassPlatform.MOBILE;case"desktop":return s.PassPlatform.DESKTOP;default:return s.PassPlatform.UNKNOWN}}static async fetchSeenStateUsers(e,t,n,i,a,r){const c=Date.now()/1e3;let _;r&&v.record(s.LoggingActions.SEEN_STATE_USERS_BEGIN,r);try{_=await o.GetSeenStateRoutes(new s.DefaultUserApiV2Client(e)).rpc("get_seen_state_users",{user_ids:n,file_info:q(i,a)},{})}catch{return void x(i)}r&&v.record(s.LoggingActions.SEEN_STATE_USERS_RECEIVE,r);const h=this.constructFakeSeenStateInfo(_,c,t);y.updateSeenStateInfo(i,h)}static processAndUpdateSeenStateInfo(e,t,s){const{seen_state_info:n,seen_state_error:i,seen_state_cursor:a}=t[0];if(i)if(s)y.discontinueSeenStateInfo(e);else{if("no_permission"===i[".tag"])return;x(e)}else{const t={seen_states:[]};for(const e of n.seen_states)t.seen_states.push({seen_state_user:e.seen_state_user,when_last_seen:e.when_last_seen,seen_events:e.seen_events,platform_type:this.parseSeenStatePassPlatform(e.platform_type)});s?y.updateSeenStateInfoContinue(e,t,a):y.updateSeenStateInfo(e,t,a)}}static async fetchSeenStateInfo(e,t,n,i,a){let r;a&&v.record(s.LoggingActions.SEEN_STATE_BEGIN,a);try{r=(await o.fetchSeenStateInfo(t,i,n)).apiData}catch{return void x(t)}let c=!0;const{seen_state_info:_,seen_state_error:h}=r[0];c=!(!_||h),y.updatePermissions(t,{canReadSeenState:c}),c||y.updateSeenStateUnavailable(e.id,t),c&&a&&v.record(s.LoggingActions.SEEN_STATE_RECEIVE,a),this.processAndUpdateSeenStateInfo(t,r,!1),c&&this.fetchRemainingSeenStateInfo(e,t,r,i)}static fetchRemainingSeenStateInfo(e,t,s,n){const i=s[0].seen_state_cursor;if(i&&i.has_next){const s=i.cursor_state;s&&this.fetchSeenStateInfoContinue(e,t,s,1e5,n)}}static async fetchSeenStateInfoContinue(e,t,n,i,a){let r;try{r=await o.GetSeenStateRoutes(new s.DefaultUserApiV2Client(e)).rpc("get_seen_state_info/continue",{file_infos:[q(t,a)],cursor:n,limit:i},{})}catch{return void y.discontinueSeenStateInfo(t)}this.processAndUpdateSeenStateInfo(t,r,!0)}static updateSeenStateOnResign(e,t,n,i,a,r){const c=B.create(n);return function(e,t,n,i,a){return e?t(o.GetSeenStateRoutes(new s.DefaultUserApiV2Client(e,a)),i):n(o.GetSeenStateRoutes(new s.NoAuthApiV2Client(a)),i)}(e||void 0,((e,t)=>e.rpc("update_timestamps_and_mark_offline",t,{})),((e,t)=>e.rpc("logged_out/mark_offline",t,{})),{beacon_infos:[{beacon_user_id:i,context:r,shared_link_url:t.url,identifier:a}]},c).then((e=>(async function(e){const t=h.getContentIdOrPathFromObjectIdentifier(e);if("file"===e[".tag"])o.seenStateInfoPackage.invalidateQueries(l.queryClient,{file_infos:[{file_identifier:t}]})}({".tag":"file",fileId:t.fileId}),e)))}}const G="online";function K(e){y.resetPassInfo(e),y.fetchPassError(e)}class W{static resetClassState(){delete this.receiverData,delete this.transmitterData,delete this.lastFileIdForReceiverTokenRequest,delete this.lastFileIdForTransmitterTokenRequest}static shutdown({viewer:e,beaconFileData:t,user:n,async:i,shouldWritePresence:a=!0}){if(this.lastFileIdForReceiverTokenRequest===t.fileId&&delete this.lastFileIdForReceiverTokenRequest,this.lastFileIdForTransmitterTokenRequest===t.fileId&&delete this.lastFileIdForTransmitterTokenRequest,this.transmitterData){const{beaconUserId:r,context:o,identifier:c}=this.transmitterData;this.transmitterData.transmitter.stop(),delete this.transmitterData,!e.is_assume_user_session&&a&&V.updateSeenStateOnResign(n,t,i,r,c,o).catch((()=>{s.UDCL.logEvent("ops.pass.error",{tags:{reason:"update_seen_state_on_resign"}})}))}this.receiverData&&this.receiverData.receiver&&(this.receiverData.receiver.stop(),delete this.receiverData)}static async receiveBeaconData({beaconFileData:e,user:t,passSessionId:n,onUpdate:i}){const{fileId:a}=e;n&&v.record(s.LoggingActions.RECEIVER_TOKEN_BEGIN,n),this.lastFileIdForReceiverTokenRequest=a;const o=await this.fetchReceiverToken(t,e).catch((()=>{s.UDCL.logEvent("ops.pass.error",{tags:{reason:"fetch_receiver_token"}})}));if(!o)return;if(this.lastFileIdForReceiverTokenRequest!==a)return;if(o.beacon_presence_error)return y.updatePermissions(a,{canReadPresence:!1}),void("no_permission"===o.beacon_presence_error[".tag"]||K(a));y.updatePermissions(a,{canReadPresence:!0}),n&&v.record(s.LoggingActions.RECEIVER_TOKEN_RECEIVE,n);const c=[new O(L,t.account_id,this.APP,o.beacon_presence_info.context,o.beacon_presence_info.token)];this.receiverData&&this.receiverData.receiver&&this.receiverData.receiver.stop(),this.receiverData={authKey:o.beacon_presence_info.auth_key,receiver:new k(c,(a=>{n&&v.record(s.LoggingActions.PRESENCE_RECEIVE,n);const r=this.parseBeaconUpdates(a[0]);i(r,t.id,e)}),(()=>this.receiveBeaconData({user:t,beaconFileData:e,passSessionId:n,onUpdate:i})),r.getDomains().THUNDER_SERVER),context:o.beacon_presence_info.context},this.receiverData.receiver.start()}static fetchReceiverToken(e,t){const{fileId:n,url:i}=t,a={file_info:$(n,i)};return s.GetFilePresenceRoutes(new s.DefaultUserApiV2Client(e)).rpc("get_pass_receiver_token",a,{})}static isOnline(e){return e&&this.HARMONY_ONLINE_STATUSES.includes(e)||e===G}static parseBeaconUpdates(e){const t={},s={},n="delta"in e?"delta":"snapshot",i="delta"in e&&e.delta?e.delta:"snapshot"in e&&e.snapshot?e.snapshot:[];for(const e of i){const n=e.agent,i=n.user_id,a=n.source.identifier;this.isOnline(e.status)?(i in t||(t[i]={}),t[i][a]=!0):(i in s||(s[i]={}),s[i][a]=!0)}return{onlineUniqueUsers:t,offlineUniqueUsers:s,type:n}}static async transmitBeaconData({user:e,passSessionId:t,beaconFileData:n,prevBeaconFileData:i}){const{fileId:a}=n;this.transmitterData&&i&&(this.transmitterData.transmitter.add_or_update_agents([this.getAgentStatusForFile(this.transmitterData.beaconUserId,this.transmitterData.identifier,this.transmitterData.authKey,this.transmitterData.context,"")]),setTimeout((()=>{var e;null===(e=this.transmitterData)||void 0===e||e.transmitter.stop()}),1)),t&&v.record(s.LoggingActions.TRANSMITTER_TOKEN_BEGIN,t),this.lastFileIdForTransmitterTokenRequest=a;const o=await this.fetchTransmitterToken(e,n);if(this.lastFileIdForTransmitterTokenRequest===a){if(o.beacon_presence_error)return y.updatePermissions(a,{canWritePresence:!1}),void("no_permission"===o.beacon_presence_error[".tag"]||K(a));y.updatePermissions(a,{canWritePresence:!0}),t&&v.record(s.LoggingActions.TRANSMITTER_TOKEN_RECEIVE,t),this.transmitterData={identifier:s.UUID.v4(),beaconUserId:o.beacon_presence_info.beacon_user_id,authKey:o.beacon_presence_info.auth_key,transmitter:new D(o.beacon_presence_info.token,r.getDomains().BEACON_SERVER,(()=>this.transmitBeaconData({user:e,passSessionId:t,beaconFileData:n,prevBeaconFileData:null}))),context:o.beacon_presence_info.context},this.transmitterData.transmitter.add_or_update_agents([this.getAgentStatusForFile(this.transmitterData.beaconUserId,this.transmitterData.identifier,this.transmitterData.authKey,this.transmitterData.context,G)]),this.transmitterData.transmitter.start()}}static getAgentStatusForFile(e,t,s,n,i){const a=new A(this.PLATFORM,this.SURFACE,t),r=new N(e,this.APP,n,a);return new R(r,i,s)}static async fetchTransmitterToken(e,t){const{fileId:n,url:i}=t,a={file_info:$(n,i)};e||i||c.reportStack("For logged out user URL is needed for get_pass_transmitter_token",{tags:["file_presence","file_presence_js"],severity:"non-critical"});return(await s.passFacepilePackage(null==e?void 0:e.id).fetchQuery(l.queryClient,{apiArg:a})).apiData}}function $(e,t){return t?{".tag":"shared_link_details",url:t}:{".tag":"file_identifier",file_identifier:e}}W.APP="harmony",W.PLATFORM=T.WEB,W.SURFACE="file_viewer",W.HARMONY_ONLINE_STATUSES=["modifier","viewer"];class Q{constructor(){this.userIdToUniqueIds={}}addUniqueUser(e,t){e in this.userIdToUniqueIds||(this.userIdToUniqueIds[e]={}),this.userIdToUniqueIds[e][t]=!0}removeUniqueUser(e,t){e in this.userIdToUniqueIds&&t in this.userIdToUniqueIds[e]&&(delete this.userIdToUniqueIds[e][t],Object.keys(this.userIdToUniqueIds[e]).length||delete this.userIdToUniqueIds[e])}getOnlineUserIds(){return Object.keys(this.userIdToUniqueIds)}}class j extends t.Store{constructor(e){super(e),this.seenStateInfos={},this.seenStateCursors={},this.presenceInfos={},this.passFetchingStatusMap={},this.userIdsWithoutSeenStateInfoMap={},this.passPermissions={}}presence(e){return e in this.presenceInfos?this.presenceInfos[e].getOnlineUserIds():null}seenStateInfo(e){return this.seenStateInfos[e]||null}identifiedSeenStateInfo(e){if(e in this.seenStateInfos){return{seen_states:i.reject(this.seenStateInfos[e].seen_states,s.AnonymousViewerUtils.isAnonymousSeenState)}}return null}seenStateCursorHasNext(e){var t,s;return null!==(s=null===(t=this.seenStateCursors[e])||void 0===t?void 0:t.has_next)&&void 0!==s?s:null}seenStateCursorState(e){var t,s;return null!==(s=null===(t=this.seenStateCursors[e])||void 0===t?void 0:t.cursor_state)&&void 0!==s?s:null}passFetchingStatus(e){return this.passFetchingStatusMap[e]||s.PassFetchingStatus.NOT_YET_KNOWN}getLinkAndGroupSeenStateInfo(e){let t=null,n=null;if(!this.seenStateInfos[e])return{linkSeenStateInfo:t,groupSeenStateInfo:n};t=[],n={};for(const i of this.seenStateInfos[e].seen_states)if(!s.AnonymousViewerUtils.isAnonymousSeenState(i)){const{seen_state_user:{sharing_access_type:e}}=i;if(e)switch(e[".tag"]){case"link_only":case"view_link_access":case"edit_link_access":t.push(i);break;case"view_member_access":case"edit_member_access":const s=e.group_ids;for(const e of s)e in n||(n[e]=[]),n[e].push(i)}}return{linkSeenStateInfo:t,groupSeenStateInfo:n}}anonymousPresence(e){return e in this.presenceInfos?s.AnonymousViewerUtils.getAnonymousUserIds(this.presenceInfos[e].getOnlineUserIds()):null}userIdsWithoutSeenStateInfo(e){return this.userIdsWithoutSeenStateInfoMap[e]||[]}isPassPermissionsPending(e){const t=this.passPermissions[e];return null!=t&&!(t.hasOwnProperty("canReadPresence")&&t.hasOwnProperty("canReadSeenState")&&t.hasOwnProperty("canWritePresence"))}getPassPermissions(e){if(!e)return null;const t=this.passPermissions[e];return null==t||this.isPassPermissionsPending(e)?null:t}resetPassInfo(e){delete this.seenStateInfos[e],delete this.seenStateCursors[e],delete this.presenceInfos[e],delete this.passFetchingStatusMap[e],delete this.passPermissions[e],delete this.userIdsWithoutSeenStateInfoMap[e],this.emit_change()}setPassPermissionRequest(e){this.passPermissions[e]||(this.passPermissions[e]={}),this.setPassFetchingStatus(e,s.PassFetchingStatus.FETCHING)}updatePermissions(e,t){this.passPermissions.hasOwnProperty(e)&&(this.passPermissions[e]={...this.passPermissions[e],...t},this.emit_change())}markPassConcludedIfNecessary(e){const t=this.passPermissions[e];!(t&&t.hasOwnProperty("canReadPresence")&&t.hasOwnProperty("canReadSeenState"))||t.canReadPresence||t.canReadSeenState||(this.resetPassInfo(e),this.setPassFetchingStatus(e,s.PassFetchingStatus.CONCLUDED),this.updateSeenStateInfoWithEmptyData(e))}receivePresenceDelta(e,t,i,a){n.assert(-1===[s.PassFetchingStatus.FETCHING,s.PassFetchingStatus.NOT_YET_KNOWN].indexOf(this.passFetchingStatus(t)),"Before handling a presence delta, you must call assurePresenceSuccessRegistered");const r=this.getOnlineUsersForFileId(t);this.updatePresenceInfos(t,i,a),this.updateUserIdsWithoutSeenStateInfo(e,t,r),this.emit_change()}receivePresenceSnapshot(e,t,i){n.assert(-1===[s.PassFetchingStatus.FETCHING,s.PassFetchingStatus.NOT_YET_KNOWN].indexOf(this.passFetchingStatus(t)),"Before handling a presence snapshot, you must call assurePresenceSuccessRegistered");const a=this.getOnlineUsersForFileId(t);this.presenceInfos[t]=new Q,this.updatePresenceInfos(t,i,{}),this.updateUserIdsWithoutSeenStateInfo(e,t,a),this.emit_change()}getOnlineUsersForFileId(e){return e in this.presenceInfos||(this.presenceInfos[e]=new Q),this.presenceInfos[e].getOnlineUserIds()}updatePresenceInfos(e,t,s){for(const t of Object.keys(s))for(const n of Object.keys(s[t]))this.presenceInfos[e].removeUniqueUser(t,n);for(const s of Object.keys(t))for(const n of Object.keys(t[s]))this.presenceInfos[e].addUniqueUser(s,n)}updateUserIdsWithoutSeenStateInfo(e,t,n){let a;const r=s.AnonymousViewerUtils.filterAnonymousUserIds(this.getOnlineUsersForFileId(t)),o=s.AnonymousViewerUtils.filterAnonymousUserIds(n),c=i.difference(o,r),_=i.difference(r,o);if(t in this.seenStateInfos){let e;const n=this.passFetchingStatus(t);if(-1!==[s.PassFetchingStatus.SEEN_STATE_DISALLOWED,s.PassFetchingStatus.PASS_MIXED_SUCCESS].indexOf(n))({userIdsWithoutSeenStateInfo:a,baseSeenStateInfo:e}=this.createMinimalBaseSeenStateInfo(t,r)),this.updateSeenStateInfo(t,e);else{const s=this.makeSeenStateAgreeWithUpdatedPresence(t,r,c,_);({userIdsWithoutSeenStateInfo:a,baseSeenStateInfo:e}=s)}}else a=[];this.userIdsWithoutSeenStateInfoMap[t]=a}makeSeenStateAgreeWithUpdatedPresence(e,t,s,n){const i=[],a=this.seenStateInfos[e],r=a.seen_states,o=[],c=[],_=[],h=Date.now()/1e3;for(const e of r){const t=e.seen_state_user.user_id;t&&(i.push(t),n.includes(t)?(e.when_last_seen=h,e.seen_events=e.seen_events||[],c.push(e)):s.includes(t)?(e.when_last_seen=h,e.seen_events=e.seen_events||[],e.seen_events.push({ts:h}),_.push(e)):o.push(e))}return a.seen_states=[...c,..._,...o],{userIdsWithoutSeenStateInfo:t.filter((e=>!i.includes(e))),baseSeenStateInfo:a}}createMinimalBaseSeenStateInfo(e,t){const s=[],n=[];for(const i of this.seenStateInfos[e].seen_states){const e=i.seen_state_user.user_id;e&&t.includes(e)&&(s.push(i),n.push(e))}return{userIdsWithoutSeenStateInfo:i.difference(t,n),baseSeenStateInfo:{seen_states:s}}}updateSeenStateInfo(e,t,i=!1){n.assert(-1===[null,s.PassFetchingStatus.FETCHING].indexOf(this.passFetchingStatus(e)),"Before updating seen state info, you must call assureSeenStateSuccessRegistered or onFetchSeenStateDisabled"),i&&e in this.seenStateInfos?this.seenStateInfos[e].seen_states=this.seenStateInfos[e].seen_states.concat(t.seen_states):this.seenStateInfos[e]=t,this.userIdsWithoutSeenStateInfoMap[e]=[],this.emit_change()}updateSeenStateInfoWithEmptyData(e){this.updateSeenStateInfo(e,{seen_states:[]})}setPassFetchingStatus(e,t){this.passFetchingStatusMap[e]=t,this.emit_change()}updateSeenStateCursor(e,t){t&&(this.seenStateCursors[e]=t,this.emit_change())}assureSeenStateSuccessRegistered(e){switch(this.passFetchingStatus(e)){case s.PassFetchingStatus.FETCHING:this.setPassFetchingStatus(e,s.PassFetchingStatus.SEEN_STATE_SUCCESS);break;case s.PassFetchingStatus.PRESENCE_SUCCESS:this.setPassFetchingStatus(e,s.PassFetchingStatus.PASS_SUCCESS);break;case s.PassFetchingStatus.SEEN_STATE_DISALLOWED:s.UDCL.logEvent("ops.pass.seen_state_store_race_condition",{tags:{reason:"assure_registered_but_disallowed"}});break;case s.PassFetchingStatus.NOT_YET_KNOWN:s.UDCL.logEvent("ops.pass.seen_state_store_race_condition",{tags:{reason:"registered_not_yet_known"}})}}onFetchSeenStateDisabled(e){switch(this.passFetchingStatus(e)){case s.PassFetchingStatus.PRESENCE_SUCCESS:this.setPassFetchingStatus(e,s.PassFetchingStatus.PASS_MIXED_SUCCESS);break;case s.PassFetchingStatus.FETCHING:this.setPassFetchingStatus(e,s.PassFetchingStatus.SEEN_STATE_DISALLOWED);break;case s.PassFetchingStatus.NOT_YET_KNOWN:s.UDCL.logEvent("ops.pass.seen_state_store_race_condition",{tags:{reason:"disabled_not_yet_known"}})}}assurePresenceSuccessRegistered(e){switch(this.passFetchingStatus(e)){case s.PassFetchingStatus.SEEN_STATE_SUCCESS:this.setPassFetchingStatus(e,s.PassFetchingStatus.PASS_SUCCESS);break;case s.PassFetchingStatus.SEEN_STATE_DISALLOWED:this.setPassFetchingStatus(e,s.PassFetchingStatus.PASS_MIXED_SUCCESS);break;case s.PassFetchingStatus.FETCHING:this.setPassFetchingStatus(e,s.PassFetchingStatus.PRESENCE_SUCCESS);break;case s.PassFetchingStatus.NOT_YET_KNOWN:s.UDCL.logEvent("ops.pass.seen_state_store_race_condition",{tags:{reason:"presence_registered_not_yet_known"}})}}_new_payload(e){const{type:t,data:n}=e.action;if(!n)return;let{userId:i,fileId:a,teamId:r,seenStateInfo:o,seenStateCursor:c,onlineUniqueUsers:_,offlineUniqueUsers:h,partialPermission:d}=n;switch(t){case s.ActionTypes$3.FETCH_PASS_ERROR:this.setPassFetchingStatus(a,s.PassFetchingStatus.ERROR);break;case s.ActionTypes$3.FETCH_PASS_CONCLUDED:this.setPassFetchingStatus(a,s.PassFetchingStatus.CONCLUDED),this.updateSeenStateInfoWithEmptyData(a);break;case s.ActionTypes$3.PASS_PERMISSION_REQUEST:this.setPassPermissionRequest(a);break;case s.ActionTypes$3.RECEIVE_PRESENCE_DELTA:this.assurePresenceSuccessRegistered(a),this.receivePresenceDelta(i,a,_,h);break;case s.ActionTypes$3.RECEIVE_PRESENCE_SNAPSHOT:this.assurePresenceSuccessRegistered(a),this.receivePresenceSnapshot(i,a,_);break;case s.ActionTypes$3.RESET_PASS_INFO:this.resetPassInfo(a);break;case s.ActionTypes$3.UPDATE_PERMISSIONS:this.updatePermissions(a,d),this.markPassConcludedIfNecessary(a);break;case s.ActionTypes$3.DISCONTINUE_SEEN_STATE_INFO:c={cursor_state:"",has_next:!1},this.updateSeenStateCursor(a,c);break;case s.ActionTypes$3.UPDATE_SEEN_STATE_INFO:this.assureSeenStateSuccessRegistered(a),this.updateSeenStateInfo(a,o),this.updateSeenStateCursor(a,c);break;case s.ActionTypes$3.UPDATE_SEEN_STATE_INFO_CONTINUE:this.assureSeenStateSuccessRegistered(a),this.updateSeenStateInfo(a,o,!0),this.updateSeenStateCursor(a,c);break;case s.ActionTypes$3.UPDATE_SEEN_STATE_UNAVAILABLE:this.onFetchSeenStateDisabled(a),this.updateSeenStateInfoWithEmptyData(a),this.updateUserIdsWithoutSeenStateInfo(i,a,[])}}}const Y=new j;class z{constructor(e,t){this.isLoaded=e,this.data=t}static create(e){return new z(!0,e)}static createNotLoaded(){return new z(!1,null)}}class X{constructor(e,t){this.fileId=e,this.url=t}}const Z=u.withActionNamespace("share-modal-actions",{SHARE_MODAL_OPEN:"share-modal-open",SHARE_MODAL_CLOSE:"share-modal-close",RESET_MODAL_STATE:"reset-modal-state",OPEN_LINK_SETTINGS_MODAL:"open-link-settings-modal",OPEN_FOLDER_SETTINGS_MODAL:"open-folder-settings-modal",OPEN_SHARED_LINK_MODAL:"open-shared-link-modal",CLOSE_LINK_SETTINGS_MODAL:"close-link-settings-modal",CLOSE_FOLDER_SETTINGS_MODAL:"close-folder-settings-modal",CLOSE_SHARED_LINK_MODAL:"close-shared-link-modal",CLEAR_METADATA:"clear-metadata",FETCH_METADATA_REQUEST:"metadata-request",FETCH_METADATA_SUCCESS:"metadata-success",FETCH_METADATA_FAILURE:"metadata-failure",CLEAR_LINK_METADATA:"clear-link-metadata",FETCH_LINK_METADATA_REQUEST:"link-metadata-request",FETCH_LINK_METADATA_SUCCESS:"link-metadata-success",FETCH_LINK_METADATA_FAILURE:"link-metadata-failure",CLEAR_SHARING_PREFS:"clear-sharing-prefs",FETCH_SHARING_PREFS_REQUEST:"sharing-prefs-request",FETCH_SHARING_PREFS_SUCCESS:"sharing-prefs-success",FETCH_SHARING_PREFS_FAILURE:"sharing-prefs-failure",ERROR_MESSAGE:"error-message",ERROR_MESSAGE_CLEAR:"error-message-clear",CLEAR_FILE_MEMBERSHIP:"clear-file-membership",FETCH_FILE_MEMBERSHIP_REQUEST:"fetch-file-membership-request",FETCH_FILE_MEMBERSHIP_SUCCESS:"fetch-file-membership-success",FETCH_FILE_MEMBERSHIP_FAILURE:"fetch-file-membership-failure",CLEAR_FOLDER_MEMBERSHIP:"clear-folder-membership",FETCH_FOLDER_MEMBERSHIP_REQUEST:"fetch-folder-membership-request",FETCH_FOLDER_MEMBERSHIP_SUCCESS:"fetch-folder-membership-success",FETCH_FOLDER_MEMBERSHIP_FAILURE:"fetch-folder-membership-failure",FETCH_USER_ACCOUNTS_REQUEST:"fetch-user-accounts-request",FETCH_USER_ACCOUNTS_SUCCESS:"fetch-user-accounts-success",FETCH_USER_ACCOUNTS_FAILURE:"fetch-user-accounts-failure",FETCH_USER_ACCOUNTS_CONTINUED_REQUEST:"fetch-user-accounts-continued-request",FETCH_USER_ACCOUNTS_CONTINUED_SUCCESS:"fetch-user-accounts-continued-success",CLEAR_FILE_MEMBERSHIP_LAST_SEEN_INFO:"clear-file-membership-last-seen-info",FETCH_FILE_MEMBER_COUNT_REQUEST:"fetch-file-member-count-request",FETCH_FILE_MEMBER_COUNT_SUCCESS:"fetch-file-member-count-success",CHANGE_RECIPIENTS:"change-recipients",CHANGE_RECIPIENT_MESSAGE:"change-recipient-message",APPEND_TO_RECIPIENT_MESSAGE:"append-to-recipient-message",CHANGE_RECIPIENT_ACCESS:"change-recipient-access",UPDATE_RECIPIENT_VALIDATION:"update-recipient-validation",CREATE_LINK_REQUEST:"create-link-request",CREATE_LINK_SUCCESS:"create-link-success",CREATE_LINK_FAILURE:"create-link-failure",UPDATE_LINK_SUCCESS:"update-link-success",DISPLAY_CONTENT_NAME_INFO:"display-content-name-info",SEND_SHARE_REQUEST:"send-share-request",SEND_SHARE_SUCCESS:"send-share-success",SEND_SHARE_FAILURE:"send-share-failure",SHARE_FOLDER_REQUEST:"share-folder-request",SHARE_FOLDER_SUCCESS:"share-folder-success",SHARE_FOLDER_FAILURE:"share-folder-failure",SEND_FOLDER_SHARE_REQUEST:"send-folder-share-request",SEND_FOLDER_SHARE_SUCCESS:"send-folder-share-success",SEND_FOLDER_SHARE_FAILURE:"send-folder-share-failure",CHANGE_MEMBER_ACCESS_REQUEST:"change-member-access-request",CHANGE_MEMBER_ACCESS_SUCCESS:"change-member-access-success",CHANGE_MEMBER_ACCESS_FAILURE:"change-member-access-failure",MEMBER_ACTION_PENDING:"member-action-pending",MEMBER_ACTION_COMPLETE:"member-action-complete",REMOVE_MEMBER_SUCCESS:"remove-member-success",REMOVE_MEMBER_KEEP_ACCESS:"remove-member-keep-access",TRANSFER_OWNER_SUCCESS:"transfer-owner-success",FETCH_CURRENT_ACCOUNT_REQUEST:"fetch-current-account-request",FETCH_CURRENT_ACCOUNT_SUCCESS:"fetch-current-account-success",FETCH_MEMBER_COUNTS_REQUEST:"fetch-member-counts-request",FETCH_MEMBER_COUNTS_SUCCESS:"fetch-member-counts-success",HANDLE_CONTENT_NAME_CHANGE:"handle-content-name-change",VALIDATE_CONTENT_NAME_SUCCESS:"validate-content-name-success",VALIDATE_CONTENT_NAME_ERROR:"validate-content-name-error",CHANGE_LINK_AUDIENCE_REQUEST:"change-link-audience-request",CHANGE_LINK_AUDIENCE_SUCCESS:"change-link-audience-success",CHANGE_LINK_AUDIENCE_FAILURE:"change-link-audience-failure",UNBLOCK_MEMBER_LIST_ON_PASS_LOAD:"unblock-member-list-on-pass-load",UPDATE_SHARING_SETTINGS_SUCCESS:"update-sharing-settings-success",DELETE_LINK_METADATA_SUCCESS:"delete-link-metadata-success",CHANGE_CREATE_COMMENT_CHECKBOX:"change-create-comment-checkbox",CHANGE_LINK_AUDIENCE_SELECTION:"change-link-audience-selection",TOGGLE_OPEN_AUTOMATIONS:"toggle-open-automations",SETTINGS_TOOLTIP_CLOSE:"settings-tooltip-close"}),J=u.withActionNamespace("sharing-actions",{CLEAR_EVERYTHING:"clear-everything",FETCH_METADATA_BATCH_ATTEMPT:"fetch-metadata-batch-attempt",FETCH_METADATA_BATCH_SUCCESS:"fetch-metadata-batch-success",FETCH_METADATA_BATCH_FAIL:"fetch-metadata-batch-fail"});var ee,te,se,ne,ie,ae,re;!function(e){e[e.NO_MEMBERS=0]="NO_MEMBERS",e[e.INPUT_CONTENT_NAME=1]="INPUT_CONTENT_NAME"}(ee||(ee={})),e.CONTENT_NAME_MESSAGE_LEVELS=void 0,(te=e.CONTENT_NAME_MESSAGE_LEVELS||(e.CONTENT_NAME_MESSAGE_LEVELS={}))[te.INFO=0]="INFO",te[te.ERROR=1]="ERROR",e.FETCH_METADATA_STATUS=void 0,(se=e.FETCH_METADATA_STATUS||(e.FETCH_METADATA_STATUS={}))[se.FETCHING=0]="FETCHING",se[se.SUCCESS=1]="SUCCESS",se[se.FAIL=2]="FAIL",e.LinkabilityStates=void 0,(ne=e.LinkabilityStates||(e.LinkabilityStates={})).CAN_LINK="CAN_LINK",ne.INVITE_NO_LINK="INVITE_NO_LINK",ne.NO_INVITE_NO_LINK="NO_INVITE_NO_LINK",ne.CANT_LINK_TEAM_FOLDER="CANT_LINK_TEAM_FOLDER",ne.ERROR_FETCHING_LINK_INFO="ERROR_FETCHING_LINK_INFO",e.MODES=void 0,(ie=e.MODES||(e.MODES={})).LINK_ONLY="link-only",ie.LOADING="loading",ie.MEMBERSHIP="membership",ie.POINTER="pointer",ie.SHARE="share",ie.SHARE_SENDING="share-sending",ie.EVOLUTION="evolution",e.LINK_ONLY_REASON=void 0,(ae=e.LINK_ONLY_REASON||(e.LINK_ONLY_REASON={})).INSIDE_SHARED_FOLDER="inside_shared_folder",ae.CONTAINS_SHARED_FOLDER="contains_shared_folder",ae.LINKS_PAGE="links_page",ae.TOTAL_MOUNTS_EXCEEDED="total_mounts_exceeded",ae.HOME_MOUNTS_EXCEEDED="home_mounts_exceeded",ae.TREE_SIZE_EXCEEDED="tree_size_exceeded",e.NS_LIMIT_ERROR=void 0,(re=e.NS_LIMIT_ERROR||(e.NS_LIMIT_ERROR={})).TOTAL_MOUNTS_EXCEEDED="total_mounts_exceeded",re.HOME_MOUNTS_EXCEEDED="home_mounts_exceeded",re.TREE_SIZE_EXCEEDED="tree_size_exceeded";const oe=S.intl.formatMessage({id:"mYGncD",defaultMessage:"Name your shared folder"});var ce;i.values(e.MODES),i.values(ee),i.values(e.CONTENT_NAME_MESSAGE_LEVELS),e.LINK_CREATION_SURFACE=void 0,(ce=e.LINK_CREATION_SURFACE||(e.LINK_CREATION_SURFACE={})).COPY_OR_CREATE_LINK_SECTION="COPY_OR_CREATE_LINK_SECTION",ce.NO_DOWNLOAD_EXPERIMENT="NO_DOWNLOAD_EXPERIMENT";const _e={canRelinquishMembership:!1,contentInfo:E.ContentInfo.createFromParams({fqPath:"",isFolder:!1}),contentNameInputValue:"",contentNameMessageLevel:e.CONTENT_NAME_MESSAGE_LEVELS.INFO,initialProps:{},initialRecipientTokens:[],isContentNameFocused:!1,pendingMemberAction:s.immutableExports.Set(),recipientMessage:"",recipientRawInput:"",recipientTokens:[],recipientValidation:{},referrer:"",shareAsConfidential:!1,uiMode:e.MODES.MEMBERSHIP,fetchMetadataStatus:e.FETCH_METADATA_STATUS.FETCHING,automationOptionChecked:!1,settingsTooltipHasBeenClosed:!1};function he(e,t){return t.shared_folder_id?e.setNsId(t.shared_folder_id):e}const de={areMembersFullyLoaded:!1,areSharingPrefsLoaded:!1,sharingPrefsFetchComplete:!1,hasDisplayableMembers:!1,isLinkMetadataLoaded:!1,isCurrentAccountLoaded:!1,shouldBlockMemberListOnPassLoad:!0,memberCounts:new s.MemberCounts,members:new s.SharingMembership,sharingPrefs:new s.SharingPrefs,sharedLinks:[],selectedAudience:void 0};function le(e,t){const s=e.metadata,n=t.permissions||s&&s.permissions;return t.set("permissions",n)}const ue=e=>[e.shared_folder_id,e.id,e.path_lower].filter((e=>!!e)),Ee=e=>"V1"===e||"V3"===e,Se=(e,t)=>((t=String(t)).startsWith("id:")||(t=t.toLowerCase()),`${e}::${t}`);class pe extends t.Store{constructor(){super(),this.sharingInfoMap={}}getSharingInfo(e,t){return t?this.sharingInfoMap[Se(e,t)]:null}mapContentIdsToSharingInfo(e,t,s){for(const n of t)n&&(this.sharingInfoMap[Se(e,n)]=s)}_new_payload(e){if(e&&e.action&&e.action.type)switch(e.action.type){case J.CLEAR_EVERYTHING:this.sharingInfoMap={};break;case J.FETCH_METADATA_BATCH_SUCCESS:{const t=e.action.user;e.action.data.forEach((e=>{this._new_payload_for_single_content(Z.FETCH_METADATA_SUCCESS,t,ue(e),{metadata:e})})),this.emit_change();break}default:if(!e.action.contentIds)return;this._new_payload_for_single_content(e.action.type,e.action.user,e.action.contentIds,e.action.data),this.emit_change()}}_new_payload_for_single_content(t,i,a,r){let o;n.assert(Boolean(i.id),"valid user needed"),n.assert(a.length>0,"contentIds cannot be empty");for(const e of a){const t=Se(i.id,e);if(t in this.sharingInfoMap){o=this.sharingInfoMap[t];break}}o||(o=new Ie(i));const c={type:t,payload:r,user:i};return o.setState(((t,n)=>{const i=n.payload;switch(n.type){case Z.CHANGE_CREATE_COMMENT_CHECKBOX:return{...t,isShareMessageAsCommentExplicitlyChecked:i.checked};case Z.CHANGE_RECIPIENTS:{const s=i.recipientTokens,n=i.recipientRawInput;let a=t.uiMode;return s.length>0||n.length>0?a===e.MODES.MEMBERSHIP&&(a=e.MODES.SHARE):a===e.MODES.SHARE&&(a=e.MODES.MEMBERSHIP),{...t,recipientTokens:s,recipientRawInput:n,uiMode:a}}case Z.CHANGE_RECIPIENT_ACCESS:return{...t,recipientAccess:i.newAccess};case Z.CHANGE_RECIPIENT_MESSAGE:return{...t,recipientMessage:i.message};case Z.APPEND_TO_RECIPIENT_MESSAGE:const n=t.recipientMessage,a=i.messageToAppend;return{...t,recipientMessage:0===n.length?a:n+"\n"+a};case Z.UPDATE_RECIPIENT_VALIDATION:const r=i.recipientValidation,o=i.resetCurrentValidations?{}:t.recipientValidation,c={};return s.ACCESS_VALUES.forEach((e=>{const t=o[e]||{},s=r[e]||{};c[e]={...t,...s}})),{...t,recipientValidation:c};case Z.FETCH_METADATA_FAILURE:return{...t,uiMode:e.MODES.LINK_ONLY,linkOnlyReason:t.linkOnlyReason!==e.LINK_ONLY_REASON.LINKS_PAGE?i.reason:t.linkOnlyReason,fetchMetadataStatus:e.FETCH_METADATA_STATUS.FAIL,countsExceedNsLimit:i.countExceedNsLimit};case Z.FETCH_METADATA_SUCCESS:{const n=i.metadata,a=n.path_lower&&s.isWebShortcutByExtension(n.path_lower)?e.MODES.POINTER:t.uiMode;return{...t,uiMode:a,contentInfo:he(t.contentInfo,n),fetchMetadataStatus:e.FETCH_METADATA_STATUS.SUCCESS}}case Z.HANDLE_CONTENT_NAME_CHANGE:return{...t,contentNameInputValue:i.name,contentNameMessageLevel:e.CONTENT_NAME_MESSAGE_LEVELS.INFO,contentNameMessage:""===i.name?oe:void 0};case Z.HANDLE_CONTENT_NAME_FOCUS_CHANGE:return{...t,isContentNameFocused:i.focus};case Z.MEMBER_ACTION_COMPLETE:return{...t,pendingMemberAction:t.pendingMemberAction.delete(i.member.memberKey())};case Z.MEMBER_ACTION_PENDING:return{...t,pendingMemberAction:t.pendingMemberAction.add(i.member.memberKey())};case Z.REMOVE_MEMBER_KEEP_ACCESS:case Z.REMOVE_MEMBER_SUCCESS:return{...t,pendingMemberAction:t.pendingMemberAction.delete(i.member.memberKey())};case Z.SEND_SHARE_FAILURE:return{...t,uiMode:e.MODES.SHARE};case Z.SEND_SHARE_REQUEST:return{...t,uiMode:e.MODES.SHARE_SENDING};case Z.SEND_SHARE_SUCCESS:return{...t,uiMode:e.MODES.SHARE};case Z.SHARE_FOLDER_SUCCESS:return{...t,contentInfo:he(t.contentInfo,i.metadata)};case Z.SHARE_MODAL_OPEN:{const n=i.shareModalInfoAttrs.contentInfo,a=i.shareModalInfoAttrs.inLinksPage,r=n.isFolder()&&!n.pathExists(),o=r&&!i.initialProps.initialContentName;let c,_=_e.uiMode;return s.isWebShortcutByExtension(n.displayPath()||"")?_=e.MODES.POINTER:r?_=e.MODES.SHARE:a&&(_=e.MODES.LINK_ONLY,c=e.LINK_ONLY_REASON.LINKS_PAGE),{...t,contentInfo:n,linkOnlyReason:c,uiMode:_,contentNameInputValue:i.initialProps.initialContentName,contentNameMessage:o?oe:"",initialProps:i.initialProps,initialRecipientTokens:i.shareModalInfoAttrs.initialRecipientTokens||[],isContentNameFocused:o,onCreateGroupCallback:i.initialProps.onCreateGroupCallback,recipientAccess:i.initialProps.defaultRecipientAccessLevel||void 0,recipientMessage:i.initialProps.recipientMessage||"",recipientTokens:[],recipientValidation:{},referrer:i.initialProps.referrer,experiments:i.initialProps.experiments,automationOptionChecked:i.initialProps.automationOptionChecked||!1,senderReminderVariant:i.initialProps.senderReminderVariant||!1}}case Z.SHARE_MODAL_CLOSE:return{...t,initialRecipientTokens:i.tokens||t.initialRecipientTokens||[]};case Z.VALIDATE_CONTENT_NAME_ERROR:return{...t,contentNameMessage:i.errorMsg,contentNameMessageLevel:e.CONTENT_NAME_MESSAGE_LEVELS.ERROR};case Z.VALIDATE_CONTENT_NAME_SUCCESS:return{...t,contentInfo:t.contentInfo.setFQPath(i.newFolderPath)};case Z.TOGGLE_OPEN_AUTOMATIONS:return{...t,automationOptionChecked:!t.automationOptionChecked};case Z.SETTINGS_TOOLTIP_CLOSE:return{...t,settingsTooltipHasBeenClosed:!0};default:return t}})(o.modalInfoState(),c),((e=de,t)=>{const n=t.payload;switch(t.type){case Z.CHANGE_MEMBER_ACCESS_FAILURE:return{...e,members:e.members.setIn([n.member.type(),n.member.memberKey(),"access_type"],n.prevAccess)};case Z.CHANGE_MEMBER_ACCESS_REQUEST:return{...e,members:e.members.setIn([n.member.type(),n.member.memberKey(),"access_type"],n.newAccess)};case Z.CLEAR_FILE_MEMBERSHIP_LAST_SEEN_INFO:return{...e,members:e.members.update("users",(e=>e.map((e=>e.set("time_last_seen",null)))))};case Z.CREATE_LINK_SUCCESS:return{...e,linkMetadata:n.linkMetadata,sharedLinks:e.sharedLinks.concat(n.linkMetadata)};case Z.UPDATE_LINK_SUCCESS:return{...e,linkMetadata:n.linkMetadata,sharedLinks:e.sharedLinks.filter((e=>e.link_permissions.link_access_level!==n.linkMetadata.link_permissions.link_access_level)).concat(n.linkMetadata),selectedAudience:void 0};case Z.FETCH_MEMBER_COUNTS_SUCCESS:return{...e,memberCounts:n.memberCounts};case Z.FETCH_METADATA_FAILURE:return{...e,fetchingMetadataPromise:void 0};case Z.FETCH_METADATA_REQUEST:return{...e,fetchingMetadataPromise:n.promise};case Z.FETCH_METADATA_SUCCESS:return{...e,metadata:le(e,n.metadata),fetchingMetadataPromise:void 0};case Z.FETCH_SHARING_PREFS_REQUEST:return{...e,sharingPrefsFetchComplete:!1};case Z.FETCH_SHARING_PREFS_SUCCESS:return{...e,areSharingPrefsLoaded:!0,sharingPrefsFetchComplete:!0,sharingPrefs:n.sharingPrefs};case Z.FETCH_LINK_METADATA_FAILURE:return{...e,isLinkMetadataLoaded:!0,linkMetadata:void 0,sharedLinks:[]};case Z.FETCH_LINK_METADATA_SUCCESS:return{...e,isLinkMetadataLoaded:!0,linkMetadata:n.sharedLinks.length>0?n.sharedLinks[0]:null,sharedLinks:n.sharedLinks,selectedAudience:void 0};case Z.DELETE_LINK_METADATA_SUCCESS:{const t=[];for(const s of e.sharedLinks)s.url!==n.deletedLink.url&&t.push(s);return{...e,linkMetadata:t[0]?t[0]:null,sharedLinks:t}}case Z.FETCH_USER_ACCOUNTS_REQUEST:return{...e,fetchingMembersRequest:{limitNonNull:n.limitNonNull,promise:n.promise,requestId:n.requestId}};case Z.FETCH_USER_ACCOUNTS_SUCCESS:return e.fetchingMembersRequest&&e.fetchingMembersRequest.requestId!==n.requestId||e.hasDisplayableMembers&&e.fetchingMembersRequest&&e.fetchingMembersRequest.limitNonNull<e.members.getMemberCount()?e:{...e,hasDisplayableMembers:!0,areMembersFullyLoaded:!n.members.cursor,fetchingMembersRequest:n.members.cursor?e.fetchingMembersRequest:void 0,members:n.members};case Z.FETCH_USER_ACCOUNTS_CONTINUED_SUCCESS:return e.fetchingMembersRequest&&e.fetchingMembersRequest.requestId!==n.requestId?e:{...e,areMembersFullyLoaded:!n.members.cursor,fetchingMembersRequest:n.members.cursor?e.fetchingMembersRequest:void 0,members:e.members.mergeDeep(n.members)};case Z.FETCH_CURRENT_ACCOUNT_REQUEST:return{...e,isCurrentAccountLoaded:!1};case Z.FETCH_CURRENT_ACCOUNT_SUCCESS:return{...e,isCurrentAccountLoaded:!0,isFamilyUser:n.isFamilyUser,teamPolicy:n.teamPolicy,canUseExtendedSharingControls:n.canUseExtendedSharingControls,isPaired:n.isPaired};case Z.FETCH_FILE_MEMBER_COUNT_SUCCESS:return{...e,memberCounts:new s.MemberCounts({total_unique_users:n.count,users_outside_team:0,exceeds_count:n.exceeds_limit})};case Z.REMOVE_MEMBER_KEEP_ACCESS:return{...e,members:e.members.setIn([n.member.type(),n.member.memberKey(),"access_type"],n.access)};case Z.REMOVE_MEMBER_SUCCESS:return{...e,members:e.members.deleteIn([n.member.type(),n.member.memberKey()])};case Z.SHARE_FOLDER_FAILURE:return{...e,shareFolderPromise:void 0};case Z.SHARE_FOLDER_REQUEST:return{...e,shareFolderPromise:n.promise};case Z.SHARE_FOLDER_SUCCESS:return{...e,metadata:le(e,n.metadata),shareFolderPromise:n.promise};case Z.TRANSFER_OWNER_SUCCESS:return{...e,metadata:void 0,isLinkMetadataLoaded:!1,hasDisplayableMembers:!1};case Z.UNBLOCK_MEMBER_LIST_ON_PASS_LOAD:return{...e,shouldBlockMemberListOnPassLoad:!1};case Z.UPDATE_SHARING_SETTINGS_SUCCESS:return{...e,metadata:le(e,n.metadata)};case Z.CHANGE_LINK_AUDIENCE_SELECTION:return{...e,selectedAudience:n.audience};case Z.SHARE_MODAL_OPEN:return{...e,selectedAudience:void 0};default:return e}})(o.sharingInfoState(),c)),a.push(o.fqPath()),this.mapContentIdsToSharingInfo(i.id,a,o),o}}const me=new pe;class fe{constructor(e){this.change_options=i.get(e,"change_options.allow",!1),this.edit_contents=i.get(e,"edit_contents.allow",!1),this.invite_editor=i.get(e,"invite_editor.allow",!1),this.invite_viewer=i.get(e,"invite_viewer.allow",!1),this.relinquish_membership=i.get(e,"relinquish_membership.allow",!1),this.leave_a_copy=i.get(e,"leave_a_copy.allow",!1),this.create_edit_link=i.get(e,"create_edit_link.allow"),this.create_view_link=i.get(e,"create_view_link.allow",!1),this.unshare=i.get(e,"unshare.allow",!1),this.update_confidentiality=i.get(e,"update_confidentiality.allow",!1),this.is_file_permissions=e instanceof s.FilePermissions,this.share_message_as_comment=i.get(e,"share_message_as_comment.allow",!1)}canChangeOptions(){return this.change_options}canEdit(){return this.edit_contents}canInviteEditor(){return this.invite_editor}canInviteViewer(){return this.invite_viewer}canInvite(){return this.canInviteViewer()||this.canInviteEditor()}canRelinquishMembership(){return this.relinquish_membership}canCreateEditLink(){return this.is_file_permissions&&this.create_edit_link}canCreateViewLink(){return this.is_file_permissions&&this.create_view_link}canUnshare(){return this.unshare}canUpdateConfidentiality(){return this.update_confidentiality}canLeaveACopy(){return this.leave_a_copy}canShareMessageAsComment(){return this.share_message_as_comment}}class Ie{static createFromParams(e){return new Ie(e)}constructor(e){this._user=e,this.setState(_e,de)}setState(e,t){this._modalInfo=e,this._sharingInfoState=t,t.metadata&&me.mapContentIdsToSharingInfo(this._user.id,ue(t.metadata),this)}sharingInfoState(){return this._sharingInfoState}modalInfoState(){return this._modalInfo}user(){return this._user}hasDirectMemberSelf(){const e=this.members();if(e&&1===e.users.count()){return e.users.first().account_id===this._user.account_id}return!1}hasNonSelfMembers(){const e=this.members(),t=e&&e.getMemberCount();if(!t)return!1;if(1===t&&1===e.users.count()){return e.users.first().account_id!==this._user.account_id}return!0}hasNonOwnerMembers(){return this.hasNonSelfMembers()&&this.isOwner()}hasOutsideTeamMembers(){const e=this.memberCounts();return(e?e.users_outside_team:0)>0}memberNum(){const e=this.memberCounts(),t=this.members();return e&&e.total_unique_users?e.total_unique_users:t?t.getMemberCount():void 0}memberCountWithRecipients(){return(this.memberNum()||0)+p.getMemberCountForTokens(this.recipientTokens())}getInitialProps(){return this.modalInfoState().initialProps}areMembersFullyLoaded(){return this.sharingInfoState().areMembersFullyLoaded}areSharingPrefsLoaded(){return this.sharingInfoState().areSharingPrefsLoaded}sharingPrefsFetchComplete(){return this.sharingInfoState().sharingPrefsFetchComplete}setSharingPrefs(e){this._sharingInfoState.sharingPrefs=e}sharingPrefs(){return this.sharingInfoState().sharingPrefs}canShareLink(){return!this.isConfidentialFolder()&&!p.isTeamFolderForNonTMRUser(this.isTeamSharedFolder(),this.user())&&!(this.isTeamSharedFolder()&&!this.sharingPrefs().tmr_tf_share_link_exp)&&this.contentInfo().pathExists()&&this.contentInfo().isMounted()}canDeleteLink(){const e=this.linkMetadata();return Boolean(e&&e.link_permissions.can_revoke)}contactsError(e){const t=this.recipientAccess();return p.validateContacts(e,this.recipientTokens(),this._user,this.recipientValidation()[t]||{},this.isTeamSharedFolder(),this.isFolderInsideTeamFolderTree(),this.memberCountWithRecipients())}contentId(){return this.contentInfo().id}contentInfo(){return this.modalInfoState().contentInfo}contentNameInputValue(){return this.modalInfoState().contentNameInputValue}contentNameMessage(){return this.modalInfoState().contentNameMessage}contentNameMessageLevel(){return this.modalInfoState().contentNameMessageLevel}displayPath(){const e=this.metadata();return this.contentInfo().displayPath()||e&&e.path_display||""}parentFolderName(){const e=this.metadata();if(e&&e instanceof s.SharedFileMetadata){const t=e.path_display;if(t){const e=t.split("/");if(e.length>1)return e[e.length-2]}}return e&&e instanceof s.SharedFolderMetadata&&e.parent_folder_name||""}fetchingMembersRequest(){return this.sharingInfoState().fetchingMembersRequest}fetchingMetadataPromise(){return this.sharingInfoState().fetchingMetadataPromise}filePolicy(){const e=this.metadata();return e&&e.file_policy}folderPolicy(){const e=this.metadata();return e&&e.policy}fqPath(){return this.contentInfo().displayPath()}hasDisplayableMembers(){return this.sharingInfoState().hasDisplayableMembers}hasParentSharedFolder(){const e=this.metadata();return!!e&&e.is_inside_team_folder}initialRecipientTokens(){return this.modalInfoState().initialRecipientTokens}isNonUserRelativeContext(){return this.getInitialProps().isInContentManager}isFolder(){return this.contentInfo().isFolder()}isConfidentialFolder(){const e=this.metadata();return Boolean(e&&e.is_confidential)}isContentNameFocused(){return this.modalInfoState().isContentNameFocused}isFolderInsideTeamFolderTree(){const e=this.metadata();return!!e&&e.is_inside_team_folder}isInsideSharedFolder(){const e=this.metadata();return Boolean(e&&e.parent_shared_folder_id||this.contentInfo().isInSharedFolder())}isLinkMetadataLoaded(){return this.sharingInfoState().isLinkMetadataLoaded}isMetadataLoaded(){return Boolean(this.metadata())}isOwner(){const e=this.metadata();return Boolean(e&&e.access_type===s.ACCESS_LEVEL.OWNER)}isOSXPackage(){const e=this.displayPath(),t=e.substr(e.lastIndexOf("."));return s.PACKAGE_EXTS.indexOf(t)>=0}inviteAfterSharingModalVariant(){return this.sharingPrefs().invite_after_sharing_modal_variant}getExperiments(){return this.modalInfoState().experiments}hasSeenEsignPostSharing(){return this.sharingPrefs().has_seen_esign_post_sharing}isInEsignPostSharingExclusionPeriod(){return this.sharingPrefs().is_in_esign_post_sharing_exclusion_period}isShowingFileUploadToolkitCampaign(){return this.sharingPrefs().is_showing_file_upload_toolkit_campaign}getReferrer(){return this.modalInfoState().referrer}isUserOnOwnerTeam(){const e=this.metadata();return Boolean(e&&e.owner_team&&e.owner_team.id===this._user.team_dbtid)}isCurrentAccountLoaded(){return this.sharingInfoState().isCurrentAccountLoaded}isTeamSharedFolder(){const e=this.metadata();return Boolean(e&&e.is_team_folder||this.contentInfo().isTeamSharedFolder())}isTokenizerEmpty(){return 0===this.recipientRawInput().length&&0===this.recipientTokens().length}linkMetadata(){return this.sharingInfoState().linkMetadata}sharedLinks(){return this.sharingInfoState().sharedLinks||[]}shmodelLink(){return this.sharedLinks().filter((e=>!e.isRighteousLink()))[0]}editRighteousLink(){return this.sharedLinks().filter((e=>"editor"===e.link_permissions.link_access_level))[0]}viewRighteousLink(){return this.sharedLinks().filter((e=>"viewer"===e.link_permissions.link_access_level))[0]}linkOnlyReason(){return this.modalInfoState().linkOnlyReason}countsExceedNsLimit(){return this.modalInfoState().countsExceedNsLimit}memberCounts(){return this.sharingInfoState().memberCounts}members(){return this.sharingInfoState().members}metadata(){return this.sharingInfoState().metadata}name(){const e=this.contentInfo(),t=this.metadata();return e&&e.name()||t&&t.name||""}ownerTeam(){const e=this.metadata();return e&&e.owner_team}ownerTeamPolicy(){const e=this.metadata();return e&&e.owner_team_policies}parentSharedFolderId(){const e=this.metadata();return e&&e.parent_shared_folder_id}pendingMemberAction(){return this.modalInfoState().pendingMemberAction}permissionsObj(){return new fe(this.permissions())}permissions(){const e=this.metadata();return e&&e.permissions}recipientAccess(){const e=this.modalInfoState();if(e.recipientAccess)return e.recipientAccess;{const e=this.permissionsObj().canInviteEditor()||this.permissionsObj().canCreateEditLink(),t=this.getDefaultSharingAccessLevel();if(t){const n=t===s.ACCESS_LEVEL.WRITER,i=t===s.ACCESS_LEVEL.READER;if(n&&e||i)return t}return e||this.editRighteousLink()?s.ACCESS_LEVEL.WRITER:s.ACCESS_LEVEL.READER}}recipientMessage(){return this.modalInfoState().recipientMessage}onCreateGroupCallback(){return this.modalInfoState().onCreateGroupCallback}recipientRawInput(){return this.modalInfoState().recipientRawInput}recipientTokens(){return this.modalInfoState().recipientTokens}recipientValidation(){return this.modalInfoState().recipientValidation}shareAsConfidential(){return Boolean(this.getInitialProps().shareAsConfidential)}shareFolderPromise(){return this.sharingInfoState().shareFolderPromise}shouldBlockMemberListOnPassLoad(){return this.sharingInfoState().shouldBlockMemberListOnPassLoad}shouldDisableImportContacts(){return this.getInitialProps().shouldDisableImportContacts}shouldSyncThisFolder(){return this.getInitialProps()?this.getInitialProps().shouldSyncThisFolder:null}isEncryptedFolder(){const e=this.metadata();return Boolean(null==e?void 0:e.is_encrypted)}shouldEncryptThisFolder(){return!!this.getInitialProps()&&this.getInitialProps().shouldEncryptThisFolder}teamPolicy(){return this.sharingInfoState().teamPolicy}isFamilyUser(){return this.sharingInfoState().isFamilyUser}canUseExtendedSharingControls(){return this.sharingInfoState().canUseExtendedSharingControls}isPaired(){return this.sharingInfoState().isPaired}uiMode(){return this.modalInfoState().uiMode}isCloudDoc(){const e=this.metadata();return!(!e||!e.is_cloud_doc)}isCloudEnhancedFile(){const e=this.name();if(e){const t=(e.substring(e.lastIndexOf(".")||e.length,e.length)||"").toLowerCase();return".docx"===t||".doc"===t||".pptx"===t||".ppt"===t||".xlsx"===t||".xls"===t}return!1}fetchMetadataStatus(){return this.modalInfoState().fetchMetadataStatus}shouldShowUpsellExperience(){return this.sharingPrefs().is_basic_user}shouldAutoShowLinkSettingsTooltip(){return this.sharingPrefs().should_auto_show_link_settings_tooltip&&this.shouldShowUpsellExperience()}isShareMessageAsCommentChecked(){const e=this.modalInfoState().isShareMessageAsCommentExplicitlyChecked;return void 0===e?this.permissionsObj().canShareMessageAsComment():e}shouldSuppressRedirectToBrowse(){return this.getInitialProps()?this.getInitialProps().shouldSuppressRedirectToBrowse:null}getBrowseOnboardaingPathway(){return this.getInitialProps()?this.getInitialProps().browseOnboardingPathway:null}shouldCloseImmediately(){return this.getInitialProps()?this.getInitialProps().shouldCloseImmediately:null}shouldFetchLinkMetadata(){return this.canShareLink()&&!this.isNonUserRelativeContext()&&this.contentInfo().isMounted()}getSelectedAudience(){return this.sharingInfoState().selectedAudience}getEligibleInviteAfterSharingContacts(){return((e,t)=>{const s=new Set(e.filter((e=>!e.invalid)).map((e=>e.getKey()))),n=Object.values(t),i=new Set,a=new Set,r=new Set;for(const e of n)for(const t in e)if(e.hasOwnProperty(t)&&s.has(t)){const s=e[t];if(s&&s.inviteAfterSharingEligibility){const e=s.inviteAfterSharingEligibility[".tag"];"eligible_not_seen"===e?i.add(t):"eligible_seen"===e?a.add(t):"eligible_seen_resurface"===e&&r.add(t)}}return{inviteEligibleNotSeenContacts:e.filter((e=>i.has(e.getKey())&&!e.invalid)),inviteEligibleSeenContacts:e.filter((e=>a.has(e.getKey())&&!e.invalid)),inviteEligibleSeenResurfaceContacts:e.filter((e=>r.has(e.getKey())&&!e.invalid))}})(this.recipientTokens(),this.recipientValidation())}automationOptionChecked(){return this.modalInfoState().automationOptionChecked}isExpBsxOrganizeAroundPeopleEnabled(){return this.sharingPrefs().bsx_organize_around_people}isCreateViewFolderLinkEnabled(){return this.sharingPrefs().create_view_folder_link_enabled}willRLBeCreated(e){return this.isFolder()?"editor"===e||this.isCreateViewFolderLinkEnabled():this.isCloudDoc()?(this.isCloudEnhancedFile(),!0):"viewer"===e}getTeamDefaultSharingAccessLevel(){var e;const t=s.DEFAULT_SHARING_ACCESS_LEVEL[null===(e=this.teamPolicy())||void 0===e?void 0:e.shared_link_default_permissions_policy];if(t!==s.SharingAccessLevel.UNKNOWN)return t}getDefaultSharingAccessLevel(){const e=this.getTeamDefaultSharingAccessLevel();if(e)return e;const t=this.sharingPrefs().default_sharing_access_level_setting?s.DEFAULT_SHARING_ACCESS_LEVEL[this.sharingPrefs().default_sharing_access_level_setting[".tag"]]:s.ACCESS_LEVEL.WRITER;return t===s.SharingAccessLevel.UNKNOWN?s.ACCESS_LEVEL.WRITER:t}getDefaultSharingLinkAudience(){const e=this.sharingPrefs().default_sharing_link_audience_setting?this.sharingPrefs().default_sharing_link_audience_setting[".tag"]:h.LINK_AUDIENCE.PUBLIC;return e===s.SharingLinkAudience.UNKNOWN?h.LINK_AUDIENCE.PUBLIC:e}getLastSeenTeamPolicyAudience(){const e=this.sharingPrefs().last_seen_team_policy_audience?this.sharingPrefs().last_seen_team_policy_audience[".tag"]:h.LINK_AUDIENCE.PUBLIC;return e===s.SharingLinkAudience.UNKNOWN?h.LINK_AUDIENCE.PUBLIC:e}isReplayInShareModalEnabled(){return this.sharingPrefs().is_replay_in_share_modal_enabled}isSendReminder(){return Ee(this.modalInfoState().senderReminderVariant)}}const Ce={loadFileMetadataBatch:(e,t)=>new s.FileShareApiClient({userApiProps:e}).getMetadataBatchAlpha({contentIds:t,actions:Object.keys(s.ALPHA_FILE_METADATA_PERMISSIONS)}).then((t=>a.dispatcherSingleton.dispatch({type:J.FETCH_METADATA_BATCH_SUCCESS,user:e,data:t}))),loadFileMetadata:({user:e,contentId:t,sourceUrl:n,client:i})=>{const r=me.getSharingInfo(e.id,t);if(r&&r.fetchingMetadataPromise())return r.fetchingMetadataPromise();const o=(i=i||new s.FileShareApiClient({userApiProps:e})).getMetadataAlpha({contentId:t,actions:Object.keys(s.ALPHA_FILE_METADATA_PERMISSIONS),sourceURL:n}).then((t=>{a.dispatcherSingleton.dispatch({type:J.FETCH_METADATA_BATCH_SUCCESS,user:e,data:[t]})}));return a.dispatcherSingleton.dispatch({type:Z.FETCH_METADATA_REQUEST,contentIds:[t],data:{promise:o},user:e}),o},listMembers:({user:e,contentId:t,isFolder:i,limit:r,url:o,members:c,client:_,includeSeenState:h=!0,passSessionId:d,isNonUserRelativeContext:l=!1,isPassPrefetch:u=!1})=>{n.assert(!r||r<=100,"listMembers not implemented for limit > 100");const E=r||9999999,S=me.getSharingInfo(e.id,t);if(S){const e=S.fetchingMembersRequest();if(e&&E<=e.limitNonNull)return e.promise;if(S.hasDisplayableMembers()&&E<S.members().getMemberCount())return Promise.resolve({})}const p=Math.random().toString(),m=!i;_||(_=i?l?new s.FolderShareApiClient({userApiProps:e,isNonUserRelativeContext:l,teamMemberId:e.team_member_id}):new s.FolderShareApiClient({userApiProps:e}):l?new s.FileShareApiClient({userApiProps:e,isNonUserRelativeContext:l,teamMemberId:e.team_member_id}):new s.FileShareApiClient({userApiProps:e}));const f=s=>s?(a.dispatcherSingleton.dispatch({type:Z.FETCH_USER_ACCOUNTS_CONTINUED_REQUEST,contentIds:[t],user:e}),_.listMembersContinue({cursor:s,url:o,isAlpha:m}).then((s=>{a.dispatcherSingleton.dispatch({type:Z.FETCH_USER_ACCOUNTS_CONTINUED_SUCCESS,contentIds:[t],data:{members:s,requestId:p},user:e}),f(s.cursor)}))):Promise.resolve({});let I;return d&&v.record(s.LoggingActions.LIST_MEMBERS_BEGIN,d),I=c?Promise.resolve(c):_.listMembers({contentId:t,url:o,limit:r,isAlpha:m,includeSeenState:h,isPassPrefetch:u}),I=I.then((n=>{d&&v.record(s.LoggingActions.LIST_MEMBERS_RECEIVE,d),a.dispatcherSingleton.dispatch({type:Z.FETCH_USER_ACCOUNTS_SUCCESS,contentIds:[t],data:{members:n,requestId:p},user:e}),r||f(n.cursor)})),a.dispatcherSingleton.dispatch({type:Z.FETCH_USER_ACCOUNTS_REQUEST,contentIds:[t],data:{limitNonNull:E,requestId:p,promise:I},user:e}),I},fetchFileMemberCount:({user:e,contentId:t,limit:n,url:i,client:r,countGroupsAsMembers:o=!1,passSessionId:c,runViewerInfoChecks:_=!1,isPassPrefetch:h=!1})=>{r=r||new s.FileShareApiClient({userApiProps:e}),c&&v.record(s.LoggingActions.MEMBER_COUNTS_BEGIN,c);const d=r.getMemberCounts({contentId:t,limit:n,url:i,countGroupsAsMembers:o,runViewerInfoChecks:_,isPassPrefetch:h});return a.dispatcherSingleton.dispatch({type:Z.FETCH_FILE_MEMBER_COUNT_REQUEST,contentIds:[t],user:e}),d.then((n=>{c&&v.record(s.LoggingActions.MEMBER_COUNTS_RECEIVE,c),a.dispatcherSingleton.dispatch({type:Z.FETCH_FILE_MEMBER_COUNT_SUCCESS,contentIds:[t],data:n,user:e})}))},fetchFolderMemberCount:({user:e,contentInfo:t,client:s})=>{const n=t.id,i=t.isSharedFolder()?t.sharedFolderId():t.nsId();return a.dispatcherSingleton.dispatch({type:Z.FETCH_MEMBER_COUNTS_REQUEST,data:{},contentIds:[n],user:e}),s.getMemberCounts({contentId:i}).then((t=>{a.dispatcherSingleton.dispatch({type:Z.FETCH_MEMBER_COUNTS_SUCCESS,data:{memberCounts:t},contentIds:[n],user:e})}))}};class ge{static setup({viewer:e,user:t,fileData:n,prevFileData:i,passSessionId:a,shouldWritePresence:r=!0,skipListMembers:o=!1,limit:c=150,maxMembersSizeLimit:_=6,isFileViewer:h}){const d=n.file.file_id;if(this.shouldInitializePass(t,d,r)){try{y.passPermissionRequest(d)}catch(e){if(!(e instanceof Error&&e.message.includes("Invariant error: cannot dispatch")))throw e;s.UDCL.logEvent("ops.pass.error",{tags:{reason:"pass_permission_request_dispatcher_failed"}})}try{ge.makeAllRequests({viewer:e,user:t,fileData:n,prevFileData:i,passSessionId:a,shouldWritePresence:r,skipListMembers:o,limit:c,maxMembersSizeLimit:_,isFileViewer:h})}catch(d){s.UDCL.logEvent("ops.pass.error",{tags:{reason:"make_all_requests_failed_sync"}}),setTimeout((()=>{try{ge.makeAllRequests({viewer:e,user:t,fileData:n,prevFileData:i,passSessionId:a,shouldWritePresence:r,skipListMembers:o,limit:c,maxMembersSizeLimit:_,isFileViewer:h})}catch(e){s.UDCL.logEvent("ops.pass.error",{tags:{reason:"make_all_requests_failed_async"}})}}),0)}}}static teardown({viewer:e,user:t,fileData:s,async:n,shouldWritePresence:i=!0}){const{file:a,url:r}=s,o=a.file_id;if(this.shouldInitializePass(t,o,i)){ge.removeUnloadHandler();const s=new X(o,r);W.shutdown({viewer:e,beaconFileData:s,user:t,async:n,shouldWritePresence:i})}}static shouldInitializePass(e,t,s){return(null!==e||s)&&t}static onBeaconUpdate(e,t,s){const n=s.fileId;"delta"===e.type?y.receivePresenceDelta(t,n,e.onlineUniqueUsers,e.offlineUniqueUsers):"snapshot"===e.type&&y.receivePresenceSnapshot(t,n,e.onlineUniqueUsers)}static makeAllRequests({viewer:e,user:t,fileData:s,prevFileData:n,passSessionId:i,limit:a=150,shouldWritePresence:r=!0,skipListMembers:o=!1,maxMembersSizeLimit:c,isFileViewer:_}){const{file:h,url:d}=s,{file_id:l,fq_path:u}=h,E=l||u,S=new X(h.file_id,d);t?(E&&!o&&Ce.listMembers({user:t,contentId:E,isFolder:!1,limit:c,url:d,passSessionId:i,includeSeenState:!1,isPassPrefetch:_}),V.fetchSeenStateInfo(t,l,a,d,i),W.receiveBeaconData({beaconFileData:S,user:t,passSessionId:i,onUpdate:this.onBeaconUpdate})):y.updatePermissions(l,{canReadPresence:!1,canReadSeenState:!1});const p=e.is_assume_user_session;if(!r||p)y.updatePermissions(l,{canWritePresence:!1});else{const a=n&&new X(n.file,n.url);W.transmitBeaconData({user:t,passSessionId:i,beaconFileData:S,prevBeaconFileData:a}),ge.removeUnloadHandler(),ge.onUnload=n=>(this.teardown({viewer:e,user:t,fileData:s,async:!1,shouldWritePresence:!0}),n.returnValue=void 0,null),document.addEventListener("beforeunload",ge.onUnload)}}}ge.removeUnloadHandler=()=>{ge.onUnload&&document.removeEventListener("beforeunload",ge.onUnload),ge.onUnload=void 0},e.BeaconFileData=X,e.BeaconPresenceHelpers=W,e.FacepileInfo=z,e.PassActions=y,e.PassHelpers=ge,e.SeenStateHelpers=V,e.ShareModalActionTypes=Z,e.SharingActions=Ce,e.UserInfo=class{constructor(e,t,s,n,i,a,r,o,c){this.key=e,this.displayName=t,this.isActive=s,this.email=n,this.whenLastSeen=i,this.photoUrl=a,this.userId=r,this.sameTeam=o,this.isGuest=c}},e.getContentIdsForContentInfo=e=>{const t=[];return e.isSharedFolder()?t.push(e.sharedFolderId()):(e.extras.fileId&&t.push(e.extras.fileId),e.extras.nsId&&e.extras.nsPath&&t.push(`ns:${e.nsId()}${e.nsPath()}`)),e.displayPath()&&t.push(e.displayPath()),t},e.getGroupSeenStateInfo=e=>{const t={};if(!e)return t;for(const s of e.seen_state_info.seen_states)if(!H.isAnonymousSeenState(s)){const e=s.seen_state_user.sharing_access_type;if(e)switch(e[".tag"]){case"view_member_access":case"edit_member_access":const n=e.group_ids;for(const e of n)e in t||(t[e]=[]),t[e].push(s)}}return t},e.getLinkSeenStateInfo=(e,t)=>{const n=[],i=t&&null!==s.getEditLinkMetadata(t),a=t&&null!==s.getViewLinkMetadata(t);if(!e)return n;for(const t of e.seen_state_info.seen_states)if(!H.isAnonymousSeenState(t)){const e=t.seen_state_user.sharing_access_type;if(e)switch(e[".tag"]){case"link_only":n.push(t);break;case"view_link_access":a&&n.push(t);break;case"edit_link_access":i&&n.push(t)}}return n},e.isSenderReminderEnabled=Ee,e.passStore=Y,e.sharingInfoStore=me,e.useSeenStateInfo=e=>{const t=function(e){const{isNonUserRelativeContext:t}=d.useSharingApiContext(),s=h.getContentIdOrPathFromObjectIdentifier(e);return o.seenStateInfoPackage.useQuery({apiArg:{file_infos:[{file_identifier:s}],limit:150}},{staleTime:3e5,enabled:"file"===e[".tag"]&&!t})}(e),{isNonUserRelativeContext:s}=d.useSharingApiContext();return f.useMemo((()=>!t||"file"!==e[".tag"]||s?{isLoading:!1,isError:!1,output:{seen_state_info:{seen_states:[]},file_info:{}}}:t.isLoading||!t.data?{isLoading:!0}:t.error?{isLoading:!1,isError:!0,error:t.error.appError}:t.data.apiData&&0!==t.data.apiData.length?{output:t.data.apiData[0],isLoading:!1,isError:!1}:{isLoading:!1,isError:!1,output:{seen_state_info:{seen_states:[]},file_info:{}}}),[t,e,s])}}));
//# sourceMappingURL=c_pass_pass_helpers.js-vflwf05sU.map

//# debugId=cc0e4a37-4064-3507-8dad-6fcca280fa7f