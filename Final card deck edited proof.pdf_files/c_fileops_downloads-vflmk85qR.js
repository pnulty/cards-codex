!function(){try{var e="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{},n=(new e.Error).stack;n&&(e._sentryDebugIds=e._sentryDebugIds||{},e._sentryDebugIds[n]="f15d29f0-53b3-3df7-80d2-a7bc312da0fb")}catch(e){}}();
define(["exports","./c_ncct_manual_assist_util","./c_action_bar_action_bar_constants","./c_bem","./e_ui_page_files_router","./c_core_notify","./c_core_i18n","./c_src_sink_index"],(function(e,o,t,n,a,r,s,i){"use strict";function l(e){return{class:"file_actions",action:"request",object:"download_file",properties:e}}const d=[o.getDomains().BLOCK_CLUSTER,o.getDomains().PUBSERVER],c="."+o.getDomains().DROPBOX_USER_CONTENT_DOMAIN,u=s.intl.formatMessage({id:"L64bdq",defaultMessage:"There was an error downloading your file."});let g=!1,_={};function f({source:e,type:o,loggingParams:t}){var n;i.getMetricsReporter().createStats({ns:"web_file_actions",name:"download/failed"},{source:e,type:o}).record(1);const r=(null==t?void 0:t.actionSurface)||"unknown",s=(null==t?void 0:t.actionElement)||"unknown",d=null!==(n=null==t?void 0:t.downloadAsZip)&&void 0!==n&&n,c=(null==t?void 0:t.downloadId)||"";a.UDCL.logEvent(l({...t,eventState:"failed",failureType:o,actionSurface:r,actionElement:s,downloadAsZip:d,downloadId:c}),{tags:{event_state:"failed",action_surface:r,download_as_zip:d.toString()}})}const m=({url:e,error:s,source:m="unknown",getProxyUrl:y,loggingParams:v})=>{const E=n.URI.parse(e),P=E.getAuthority(),b=function(){let e="";for(let o=1;o<=4;o++)e+=String(Math.random()).split(".")[1];return e}();(v=v||{}).downloadId=b,function({source:e,loggingParams:o}){var t;i.getMetricsReporter().createStats({ns:"web_file_actions",name:"download/attempt"},{source:e}).record(1);const n=(null==o?void 0:o.actionSurface)||"unknown",r=(null==o?void 0:o.actionElement)||"unknown",s=null!==(t=null==o?void 0:o.downloadAsZip)&&void 0!==t&&t,d=(null==o?void 0:o.downloadId)||"";a.UDCL.logEvent(l({...o,eventState:"start",actionSurface:n,actionElement:r,downloadAsZip:s,downloadId:d}),{tags:{event_state:"start",action_surface:n,download_as_zip:s.toString()}})}({source:m,loggingParams:v});const M=sessionStorage.getItem("disablePreviewPublishEvents");M&&"false"!==M||a.publishEvent(a.CampaignEvents.FILE_DOWNLOAD_START);const S=d.includes(P)||P.endsWith(c)||P===o.getDomains().WEBSERVER;S||f({source:m,type:"download_non_block_server",loggingParams:v}),n.assert(S,"attempt to download from a non-blockserver domain",{exc_extra:{domain:P,url:e}}),g||(g=!0,_={},window.addEventListener("message",w)),E.updateQuery({_download_id:b,_notify_domain:window.location.host,_log_download_success:"1"});const A=String(E),k=y?y(A):A;return p({downloadUrl:k,downloadId:b,error:s,downloadDomain:P,onLoad:()=>{setTimeout((()=>{const e=_[b];null!=e&&(t.chrome&&(r.Notify.error(u),e.error&&(e.error(),f({source:e.source,type:"download_failed",loggingParams:e.loggingParams}))),h(b))}),1e4)},source:m,loggingParams:v}),!1},p=({downloadUrl:e,downloadId:o,error:t,downloadDomain:n,onLoad:a,source:r,loggingParams:s})=>{const i=document.createElement("iframe");i.setAttribute("src",e),i.style.display="none",a&&i.addEventListener("load",a),_[o]={origin:n,error:t,iframe:i,source:r,loggingParams:s},document.body.appendChild(i),window.setTimeout((()=>h(o)),9e4)};function w(e){const o=n.URI.parse(e.origin);if("https"!==o.getScheme())return;if(!d.includes(o.getAuthority())&&!o.getAuthority().endsWith(c))return;let t;try{t=JSON.parse(e.data)}catch(e){return}if(!t||!t.download_id)return;const a=_[t.download_id];if(null!=a&&o.getAuthority()===a.origin&&e.source===a.iframe.contentWindow){if("failed"===t.status){const e=(t.message||u)+'<a target="_blank" rel="noreferrer" href="/help/desktop-web/download-entire-folders">'+s.intl.formatMessage({id:"WYQtmB",defaultMessage:"More info"})+"</a>";r.Notify.error(new r.HTML(e)),a.error&&(a.error(),f({source:a.source,type:"download_failed",loggingParams:a.loggingParams}))}h(t.download_id)}}function h(e){const o=_[e];null!=o&&(o.iframe.remove(),delete _[e])}e.get=m,e.get_zip=async function({userApiProps:e,fq_paths:o,block_hash:t,parent_path:n,flat_zip_mode:r,source:i="unknown",root_ns_id:l,loggingParams:d}){""===n&&(n="/");const c=await(async({userApiProps:e,block_hash:o,fq_paths:t,parent_path:n,flat_mode:r,root_ns_id:s})=>{try{const i=new a.DefaultUserApiV2Client(e),l=await function(e){return e.ns("browse_zip_downloads")}(i).rpc("get_zip_download_url",{block_hash:o,unnormalized_files:[...t],parent_path:n,flat_mode:r,root_ns_id:s},{});return{result:l,isError:!1}}catch(e){return e instanceof a.ApiError?{isError:!0,error:e.error}:{isError:!0,error:{".tag":"undefined_error"}}}})({userApiProps:e,block_hash:t,fq_paths:[...o],parent_path:n,flat_mode:!!r,root_ns_id:l});if(c.isError)(e=>{let o;o="too_many_files"===e[".tag"]?s.intl.formatMessage({id:"ZvH26K",defaultMessage:"Attempted to zip too many files."}):"too_much_data"===e[".tag"]?s.intl.formatMessage({id:"Qq4R12",defaultMessage:"Attempted to zip too much data."}):"file_not_found"===e[".tag"]?s.intl.formatMessage({id:"XSR4O8",defaultMessage:"File not found."}):"unauthorized_user"===e[".tag"]?s.intl.formatMessage({id:"tUjhJf",defaultMessage:"Unauthorized user."}):"unauthorized_namespace"===e[".tag"]?s.intl.formatMessage({id:"62VIQy",defaultMessage:"You can't download because you can't access all content.  Please try again, selecting only folders where you have access to all the content."}):s.intl.formatMessage({id:"ItwtZa",defaultMessage:"Zip download failed."}),a.Snackbar.fail(o,"zip-download-status")})(c.error),f({source:i,type:"zip_download_error",loggingParams:{...d,downloadAsZip:!0}});else{const{url:e}=c.result;m({url:e,source:i,loggingParams:{...d,downloadAsZip:!0}})}}}));
//# sourceMappingURL=c_fileops_downloads.js-vflvAn-l7.map

//# debugId=f15d29f0-53b3-3df7-80d2-a7bc312da0fb