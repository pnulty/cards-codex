!function(){try{var e="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{},n=(new e.Error).stack;n&&(e._sentryDebugIds=e._sentryDebugIds||{},e._sentryDebugIds[n]="549f8fa6-7391-3545-8b85-0435351ba7b1")}catch(e){}}();
define(["exports","./e_ui_page_files_router","./e_core_exception"],(function(e,t,r){"use strict";function n(){return(new Date).getTime()}let o=null;const a="UG_DBX_DB",i="UG_STORE";function s(e){return new Promise(((t,r)=>{e.onsuccess=()=>t(e.result),e.onerror=()=>r(e.error)}))}async function l(e){return(await function(){if(!o){const e=indexedDB.open(a);e.onerror=e=>{console.error("There was an issue with initializing DB ",e)},e.onupgradeneeded=()=>e.result.createObjectStore(i),o=s(e)}return o}()).transaction(i,e).objectStore(i)}function c(e){const t=e.transaction;return new Promise(((e,r)=>{t.oncomplete=()=>e(),t.onabort=t.onerror=()=>r(t.error)}))}const d={check:async()=>Boolean(await l("readonly")),get:async e=>{const t=await l("readonly");return await s(t.get(e))},has:async e=>Boolean(await d.get(e)),set:async(e,t,r=0)=>{const n=await l("readwrite");await s(n.put(t,e)),await c(n)},entries:async()=>{const e=await l("readonly"),[t,r]=await Promise.all([s(e.getAllKeys()),s(e.getAll())]),n=[];return t.forEach(((e,t)=>{n.push([e,r[t]])})),n},delete:async e=>{const t=await l("readwrite");await s(t.delete(e)),await c(t)},multiDelete:async e=>{const t=await l("readwrite");await Promise.all(e.map((e=>t.delete(e)))),await c(t)},clear:async()=>{const e=await l("readwrite");await s(e.clear()),await c(e)}};var u;e.Store=void 0,(u=e.Store||(e.Store={})).PDF_EDIT_STORE="pdfEdit",u.PDF_EDIT_UPLOAD_STORE="pdfEditUpload",u.PDF_EDIT_SHARED_STORE="pdfEditShared",u.PDF_CONVERT_STORE="pdfConvert",u.IMG_EDIT_STORE="imgEdit",u.FILE_UPLOAD="fileUpload";const _=3600,g="data",E="metadata",S="EMPTY",h="storeType",f="creationTimeStamp",w="updatedTimeStamp",p="fileName",T="ungated_idx_db_lib",D="_ugStoreKey",C="ttlSeconds",I=157286400;function y(e){return new Blob([e],{type:"text/plain"}).size}function b(e,t=r.SEVERITY.CRITICAL){console.log(`Ungated IndexedDB Store: ${e}`),r.reportException({err:new Error(e),tags:[T],severity:t})}function L(e){const[t,r]=e.split("_");return t}function R(e){if(!(w in e)||!(C in e))return!0;return Number(e[w])+1e3*Number(e[C])<n()}const U={isCompatible:async e=>{const r=await d.check();return r||t.UDCL.logEvent("ungated_idb_lib_failure",{tags:{error:"browser_compatibility",store:e}}),r},init:async(e,r=3600,o=!1)=>{t.UDCL.logStart("ungated_store_init",{tags:{state:"start",store:e}});const a=o?"all":e;await U.cleanupExpiredSessionsForStore(a);const i=function(e){return(e+"_"+t.UUID.v4()+D).toString()}(e),s=d.set(i,function(e,t){const r=n().toString();return{[g]:S,[E]:"{}",[h]:e,[f]:r.toString(),[w]:r.toString(),[p]:r.toString(),[C]:t.toString()}}(e,r));return s.then((()=>(t.UDCL.logEnd("ungated_store_init",{eventState:"success",tags:{store:e}}),i))).catch((r=>{throw b(`Could not initialize a store in indexedDB. Check browser limits or cookie settings. ${r}`),t.UDCL.logEnd("ungated_store_init",{eventState:"failed",tags:{store:e}}),r}))},setSessionData:async(e,o,a,i=3600)=>{if(0===o.byteLength||y(o)>I){const e="File is empty or size is larger than 150 MB. Exiting processing.";throw b(e,r.SEVERITY.NONCRITICAL),new Error(e)}if(!await d.has(e)||null===a){const e="SetSessionData: Invalid file metadata or session key does not exist or has expired.";throw b(e,r.SEVERITY.NONCRITICAL),new Error(e)}return d.get(e).then((t=>(t[g]=o,t[E]=JSON.stringify(a),t[w]=n().toString(),t[C]=i.toString(),d.set(e,t,i)))).catch((r=>{throw b(`Could not set session data. ${r}`),t.UDCL.logEvent("ungated_idb_lib_failure",{tags:{store:L(e),error:"set_session_data"}}),r}))},getSessionData:async e=>{if(!await d.has(e)){const e="GetSessionData: Session key does not exist or has expired.";throw b(e,r.SEVERITY.NONCRITICAL),new Error(e)}return d.get(e).then((t=>{if(!R(t))return t;U.deleteUngatedSession(e)})).catch((r=>{throw b(`Could not retrieve file data. ${r}`),t.UDCL.logEvent("ungated_idb_lib_failure",{tags:{store:L(e),error:"get_session_data"}}),r}))},hasUngatedSessionKey:async e=>await d.has(e),saveFileData:async(e,o,a=3600)=>{if(0===o.byteLength||y(o)>I){const e="File is empty or size is larger than 150 MB. Exiting processing.";throw b(e,r.SEVERITY.NONCRITICAL),new Error(e)}if(!await d.has(e)){const e="Invalid file data or session key does not exist or has expired.";throw b(e,r.SEVERITY.NONCRITICAL),new Error(e)}return d.get(e).then(((t={})=>(t[g]=o,t[w]=n().toString(),t[C]=a.toString(),d.set(e,t,a)))).catch((r=>{throw b(`Could not save file data to indexedDB. Check file size or try again. ${r}`),t.UDCL.logEvent("ungated_idb_lib_failure",{tags:{store:L(e),error:"save_file_data"}}),r}))},getFileData:async e=>{if(!await d.has(e)){const e="GetFileData: Session key does not exist or has expired.";throw b(e,r.SEVERITY.NONCRITICAL),new Error(e)}return d.get(e).then(((t={})=>{if(!R(t))return g in t?t[g]:void 0;U.deleteUngatedSession(e)})).catch((r=>{throw b(`Could not get file data from indexedDB. ${r}`),t.UDCL.logEvent("ungated_idb_lib_failure",{tags:{store:L(e),error:"get_file_data"}}),r}))},getLatestUngatedSessionKeyForStore:async e=>d.entries().then((t=>{let r="",n="0";for(const o of t){const[t,a]=o;if("all"===e||t.startsWith(e)){const e=a[w]||"0";e>=n&&(r=t,n=e)}}return r})).catch((r=>{throw b(`Could not get latest session key for ${e}. It is possible it has already expired. ${r}`),t.UDCL.logEvent("ungated_idb_lib_failure",{tags:{store:e,error:"get_latest_key"}}),r})),saveFileMetadata:async(e,o,a=3600)=>{if(null===o){const e="File metadata is null. Returning";throw b(e,r.SEVERITY.NONCRITICAL),new Error(e)}if(!await d.has(e)){const e="SaveFileMetadata: Session key does not exist or has expired.";throw b(e,r.SEVERITY.NONCRITICAL),new Error(e)}return d.get(e).then(((t={})=>(t[E]=JSON.stringify(o),t[w]=n().toString(),t[C]=a.toString(),d.set(e,t,a)))).catch((r=>{throw b(`Could not save file metadata to indexedDB. Check keys and values are set to string type for key ${e}. ${r}`),t.UDCL.logEvent("ungated_idb_lib_failure",{tags:{store:L(e),error:"save_file_metadata"}}),r}))},getFileMetadata:async e=>{if(!await d.has(e)){const e="getFileMetadata: Session key does not exist or has expired.";throw b(e,r.SEVERITY.NONCRITICAL),new Error(e)}return d.get(e).then(((t={})=>{if(!R(t))return E in t?JSON.parse(t[E]):{};U.deleteUngatedSession(e)})).catch((r=>{throw b(`Could not retrieve file metadata. ${r}`),t.UDCL.logEvent("ungated_idb_lib_failure",{tags:{store:L(e),error:"get_file_metadata"}}),r}))},cleanupOldSessionsForStore:async e=>{const r=d.entries(),n=[];return r.then((t=>{for(const r of t){const[t,o]=r;t.endsWith(D)&&("all"===e||t.startsWith(e))&&n.push(t)}return d.multiDelete(n)})).catch((r=>{throw b(`Could not delete old entries for store ${e}. ${r}`),t.UDCL.logEvent("ungated_idb_lib_failure",{tags:{store:e,error:"cleanup_old_sessions"}}),r}))},cleanupExpiredSessionsForStore:async e=>{const r=d.entries(),n=[];return r.then((t=>{for(const r of t){const[t,o]=r;t.endsWith(D)&&("all"===e||t.startsWith(e))&&R(o)&&n.push(t)}return d.multiDelete(n)})).catch((r=>{throw b(`Could not remove expired entries for store ${e}. ${r}`),t.UDCL.logEvent("ungated_idb_lib_failure",{tags:{store:e,error:"cleanup_expired_sessions"}}),r}))},deleteUngatedSession:async e=>{if(!await d.has(e)){b("DeleteUngatedSession: Session key does not exist or has expired.",r.SEVERITY.NONCRITICAL)}return d.delete(e).then((()=>{})).catch((r=>{b(`Could not retrieve file metadata. ${r}`),t.UDCL.logEvent("ungated_idb_lib_failure",{tags:{store:L(e),error:"delete_session"}})}))}};var A=Object.freeze({__proto__:null,CREATION_TIMESTAMP_KEY:f,DATA_KEY:g,DEFAULT_EXPIRATION_SECONDS:_,EMPTY_VALUE:S,ERROR_TAG:T,FILENAME_KEY:p,METADATA_KEY:E,STORE_KEY:h,get Store(){return e.Store},TTL:C,UG_STORE_KEY_SUFFIX:D,UPDATED_TIMESTAMP_KEY:w,UPLOAD_FILE_SIZE_LIMIT_MB:150,checkBufferSize:y,reportErrorMessage:b,ungatedDBStore:U});e.GetAccountRoutes=function(e){return e.ns("account")},e.PAP_Login_Account=function(e){return{class:"auth",action:"login",object:"account",properties:e}},e.PAP_SignUp_Account=function(e){return{class:"auth",action:"sign_up",object:"account",properties:e}},e.idx_db_access_lib_esnext=A,e.ungatedDBStore=U}));
//# sourceMappingURL=c_ungated_idx_db_access_lib.js-vflVeQqhn.map

//# debugId=549f8fa6-7391-3545-8b85-0435351ba7b1