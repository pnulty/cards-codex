!function(){try{var e="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{},n=(new e.Error).stack;n&&(e._sentryDebugIds=e._sentryDebugIds||{},e._sentryDebugIds[n]="83145edc-6c25-37fe-97e3-26b8b2545d9d")}catch(e){}}();
define(["exports","./e_ui_page_files_router","./c_pap-events_replay_shown_modal","./c_action_bar_action_bar_constants","./c_bem","./c_lodash-es_lodash","./c_core_i18n","./c_core_notify"],(function(e,t,_,n,s,i,r,o){"use strict";var a,c;!function(e){e.CONNECTION_TIMEOUT="connection_timeout",e.CONNECTION_CLOSED="connection_closed",e.COULD_NOT_SEND="could_not_send",e.UNEXPECTED_ERROR="unexpected_error"}(a||(a={})),function(e){e[e.LATEST=16]="LATEST",e[e.INITIAL_UNITY=1]="INITIAL_UNITY",e[e.UNITY_HANDSHAKE=2]="UNITY_HANDSHAKE",e[e.REUNITY=3]="REUNITY",e[e.OPEN_IN_FILE_BROWSER=4]="OPEN_IN_FILE_BROWSER",e[e.CHECK_FILE_RETURNS_OBJ=5]="CHECK_FILE_RETURNS_OBJ",e[e.PERMISSION_LEVELS=6]="PERMISSION_LEVELS",e[e.WEB_DESTINY=7]="WEB_DESTINY",e[e.WEB_DESTINY_V2=8]="WEB_DESTINY_V2",e[e.PORT_CHECK=9]="PORT_CHECK",e[e.CHIME_OPEN=10]="CHIME_OPEN",e[e.OPEN_COLLAB_BROWSE=16]="OPEN_COLLAB_BROWSE"}(c||(c={}));var l=c;function h(e){var _,n,s;const i=null!==(_=null==e?void 0:e.path)&&void 0!==_?_:"/unity_connection_log",r=null!==(n=null==e?void 0:e.routeParams)&&void 0!==n?n:{},o=null!==(s=null==e?void 0:e.base)&&void 0!==s?s:window.location.origin;return new t.AjaxURL(t.replacePattern(i,r),o)}function u(e){var _,n,s;const i=null!==(_=null==e?void 0:e.path)&&void 0!==_?_:"/unity_open_log",r=null!==(n=null==e?void 0:e.routeParams)&&void 0!==n?n:{},o=null!==(s=null==e?void 0:e.base)&&void 0!==s?s:window.location.origin;return new t.AjaxURL(t.replacePattern(i,r),o)}class d{constructor(){this._data={logging_source:"web",web_unity_version:l.LATEST}}update(e){return this._data={...this._data,...e},this._data}report_event(e,n={}){this._data.event_name=e,this._data.local_ts=(new Date).getTime()/1e3,this._data.extra=JSON.stringify({...n,user_id:n.user_id||_.getActiveUserId()}),t.SilentBackgroundRequest$1({url:h(),data:this._data})}get_log_data_for_client(){return{web_unity_version:this._data.web_unity_version,user_agent:window.navigator.userAgent}}unity_session_id(){return this._data.unity_session_id}}const E={canUnityConnect:()=>E.canBrowserSupportNonSecureWebsocket(),canBrowserSupportNonSecureWebsocket(){const e=parseInt(n.version,10);return!!(n.safari&&e<9)||(!!(n.mozilla&&e>=55)||(!!(n.chrome&&e>=53)||!!n.edgeChromium()))}},p={create(e){const t=new d;return E.canUnityConnect()&&t.report_event("using_default_web_socket"),new WebSocket(e)},web_sockets_supported:()=>E.canUnityConnect()};function S(e){var _,n,s;const i=null!==(_=null==e?void 0:e.path)&&void 0!==_?_:"/retrieve_unity_nonce",r=null!==(n=null==e?void 0:e.routeParams)&&void 0!==n?n:{},o=null!==(s=null==e?void 0:e.base)&&void 0!==s?s:window.location.origin;return new t.AjaxURL(t.replacePattern(i,r),o)}var N,I,f;!function(e){e.CONNECTION_OPENED="CONNECTION_OPENED",e.VERSION_CHECK="VERSION_CHECK",e.FETCHING_NONCE="FETCHING_NONCE",e.NONCE_RETURNED_TO_CLIENT="NONCE_RETURNED_TO_CLIENT",e.HANDSHAKE_COMPLETED="HANDSHAKE_COMPLETED"}(N||(N={})),function(e){e.PENDING="PENDING",e.ESTABLISHED="ESTABLISHED",e.CLOSED="CLOSED",e.RETRYING="RETRYING"}(I||(I={})),function(e){e.SECURE_PERMISSION="secure",e.INSECURE_WEB_PERMISSION="insecure_web",e.INSECURE_CLIENT_PERMISSION="insecure_client",e.INSECURE_PERMISSION="insecure"}(f||(f={}));class g{constructor(){this.client_version=null,this.logger=new d,this._on_open_callbacks=[],this._on_open_failed_callbacks=[],this._on_close_callbacks=[],this._pending_callbacks=[],this._response_callbacks={},this._webSocket=null,this._port=null,this._active_ports={},this._connection_state=I.PENDING,this._current_message_id=1,this._permission_level=null,this._on_close=e=>t=>{[1e3,1001,1005,1006].includes(t.code)||this.logger.report_event("unity_failure",{message:`WebSocket closed. Code: ${t.code}. Reason: ${t.reason}`,port:e}),this._close_port(e)},this._on_error=e=>t=>{this.logger.report_event("unity_failure",{message:"WebSocket unknown error",port:e}),this._close_port(e)},this._set_connection_state=e=>{if(e===this._connection_state)return;const t=this._connection_state;if(s.assert(t!==I.CLOSED,"Shouldn't unclose a closed connection."),this._connection_state=e,e===I.ESTABLISHED){s.assert(this._is_connection_in_progress(t),"Can only establish from pending or retrying."),this.logger.report_event("handshake_complete"),t===I.PENDING&&this._on_open_callbacks.forEach((e=>e()));const e=[];for(;this._pending_callbacks.length;){const{callback:t,error_callback:_}=this._pending_callbacks.pop();this.is_ready()?e.push(t()):e.push("function"==typeof _?_(a.UNEXPECTED_ERROR):void 0)}return e}if(e!==I.RETRYING){if(e===I.CLOSED){t===I.PENDING?(this.logger.report_event("connection_not_established"),this._on_open_failed_callbacks.forEach((e=>e()))):t===I.RETRYING?(this.logger.report_event("connection_terminated"),this._on_close_callbacks.forEach((e=>e()))):s.assert(!1,"CONNECTION_CLOSED can only be set from PENDING or RETRYING");const e=[];for(;this._pending_callbacks.length;){const{error_callback:t}=this._pending_callbacks.pop();e.push("function"==typeof t?t(a.CONNECTION_CLOSED):void 0)}return e}return s.assert(!1,"Changing connection_state to CONNECTION_PENDING not supported.")}},this._on_message=e=>t=>{const _=JSON.parse(t.data);if(_.func&&_.header&&_.header.message_id&&void 0!==_.header.should_respond)if(_.header.log_data&&this.logger.update(_.header.log_data),this.logger.update({port:e.port}),"response"===_.func)this._on_response(_.header.message_id,_.data);else{const t=this._routes[_.func];if(null==t)return void this._terminate_handshake(e.ws,"Unknown function.",{function:_.func});const n=this.is_ready()?t(_.data):t(e,_.data);_.header&&_.header.should_respond&&this.send("response",n,null,null,_.header.message_id)}else this._terminate_handshake(e.ws,"Malformed message from client.",{message:t.data})},this._on_response_timeout=e=>()=>{const{error_callback:t}=this._response_callbacks[e];delete this._response_callbacks[e],t&&t(a.CONNECTION_TIMEOUT)},this._check_unity_version=(e,t)=>{if(e.state!==N.CONNECTION_OPENED)return void this._terminate_handshake(e.ws,"Handshake version check at wrong time of protocol.");if(e.state=N.VERSION_CHECK,e.client_version=t.client_version,t.client_version<l.UNITY_HANDSHAKE)return void this._terminate_handshake(e.ws,"Client version is too old.");const _=this._web_has_auth();if(!(t.client_version<l.PERMISSION_LEVELS)||_)return this.logger.report_event("handshake_version_check"),t.client_version>=l.PERMISSION_LEVELS?this._send_with_ws(e.ws,"initiate_handshake",{secure_web:_}):this._send_with_ws(e.ws,"initiate_handshake");this._terminate_handshake(e.ws,"Client version is too old to support insecure web connections.")},this._fetch_unity_nonce=(e,t)=>{e.state===N.VERSION_CHECK?(e.state=N.FETCHING_NONCE,this.logger.report_event("handshake_fetch_nonce"),this._retrieve_unity_nonce(e,t.nonce_key)):this._terminate_handshake(e.ws,"Fetch Unity nonce at wrong time of protocol.")},this._complete_handshake=(e,t)=>{if(e.state===N.NONCE_RETURNED_TO_CLIENT&&t.is_success)if(e.state=N.HANDSHAKE_COMPLETED,this._connection_state===I.CLOSED)this._terminate_handshake(e.ws,"No more handshakes are allowed to complete.");else if(null!=this._webSocket){const t="Only one Unity handshake can succeed! There's likely a MITM attack, so close all connections.";this._terminate_handshake(e.ws,t),this._terminate_handshake(this._webSocket,t),this.client_version=null,this._webSocket=null,this._port=null,this._set_connection_state(I.CLOSED)}else this.client_version=e.client_version,this._webSocket=e.ws,this._port=e.port,this._set_connection_state(I.ESTABLISHED);else this._terminate_handshake(e.ws,"Unable to complete handshake.")},this._routes={check_unity_version:this._check_unity_version,fetch_unity_nonce:this._fetch_unity_nonce,complete_handshake:this._complete_handshake}}start(){E.canUnityConnect()?this._attempt_handshake():(this._set_connection_state(I.CLOSED),this.logger.report_event("unity_failure",{message:"WebSocket creation failed. Not able to create web socket."}))}_getWebSocketURI(e){const t={scheme:"ws",authority:`127.0.0.1:${e.toString()}`,path:"/ws"};return new s.URI(t).toString()}_attempt_handshake(){for(let e=17600;e<=17602;e++)try{this._active_ports[e]=!0;const t=p.create(this._getWebSocketURI(e));t.onmessage=this._on_message({ws:t,port:e,state:N.CONNECTION_OPENED,client_version:null,client_has_auth:null}),t.onclose=this._on_close(e),t.onerror=this._on_error(e)}catch(t){const _=t instanceof Error?t:void 0,n=(null==_?void 0:_.message)||"Unknown error";this.logger.report_event("unity_failure",{message:`WebSocket creation failed. Message: ${n}`,error_name:null==_?void 0:_.name,port:e}),this._set_connection_state(I.CLOSED)}this.logger.report_event("handshake_started")}_close_port(e){if(e in this._active_ports&&(delete this._active_ports[e],i.isEmpty(this._active_ports)))return this._connection_state===I.ESTABLISHED?this._retry_connection():this._set_connection_state(I.CLOSED)}_retry_connection(){return this.logger.report_event("connection_retrying"),this._set_connection_state(I.RETRYING),this.client_version=this._webSocket=this._port=null,this._attempt_handshake()}send(e,t=null,_=null,n=null,s=null){if(this._webSocket)return this._send_with_ws(this._webSocket,e,t,_,n,s)}_send_with_ws(e,t,_=null,n=null,i=null,r=null){if(null==r&&(r=this._current_message_id,s.assert(this._current_message_id%2==1,"Web-initiated message_ids should remain odd"),this._current_message_id+=2),null!==n){const e=window.setTimeout(this._on_response_timeout(r),5e3);this._response_callbacks[r]={response_callback:n,error_callback:i,timeout_id:e}}const o={func:t,header:{message_id:r,should_respond:null!==n,log_data:this.logger.get_log_data_for_client()}};null!=_&&(o.data=_);try{return e.send(JSON.stringify(o))}catch(e){const t=e instanceof Error?e:void 0,_=(null==t?void 0:t.message)||"Unknown error";this.logger.report_event("unity_failure",{message:`WebSocket send failed. Message: ${_}`,error_name:null==t?void 0:t.name}),i&&i(a.COULD_NOT_SEND)}}_on_response(e,t){if(e in this._response_callbacks){const{response_callback:_,timeout_id:n}=this._response_callbacks[e];delete this._response_callbacks[e],window.clearTimeout(n),_&&_(t)}}_web_has_auth(){return _.isAnyUserSignedIn()}_retrieve_unity_nonce(e,_){return t.WebRequest({url:S(),dataType:"json",data:{nonce_key:_},success:t=>{switch(t.status){case"OK":if(e.state=N.NONCE_RETURNED_TO_CLIENT,(null===e.client_version||e.client_version>=l.PORT_CHECK)&&(s.assert(t.message.client_port,`Port check must happen in version ${e.client_version}`),t.message.client_port!==e.port))return void this._terminate_handshake(e.ws,"Mismatched ports.",{client_port:t.message.client_port,web_port:e.port});e.client_has_auth=t.message.client_has_auth;const _=this._web_has_auth();return e.client_has_auth&&_?this._permission_level=g.SECURE_PERMISSION:(s.assert(null===e.client_version||e.client_version>=l.PERMISSION_LEVELS,`Insecure connections only supported by client_version >= ${l.PERMISSION_LEVELS}.`),this._permission_level=e.client_has_auth?g.INSECURE_WEB_PERMISSION:_?g.INSECURE_CLIENT_PERMISSION:g.INSECURE_PERMISSION),this.logger.update({unity_permission_level:this._permission_level}),this.logger.report_event("handshake_nonce_sent_to_unity_server"),this._send_with_ws(e.ws,"verify_unity_nonce",{nonce:t.message.nonce});case"MISMATCHED_USER_IDS":return this._terminate_handshake(e.ws,"Mismatched user_ids.",{client_user_ids:t.message.client_user_ids,web_user_ids:t.message.web_user_ids});case"INVALID":return this._terminate_handshake(e.ws,"Could not find nonce with given nonce_key.");case"AUTH_REQUIRED":return this._terminate_handshake(e.ws,"Did not have the necessary authentication to retrieve nonce.");case"LOCAL_INFORMATION_PERMISSION_REQUIRED":return this._terminate_handshake(e.ws,"Did not have permission to start a local-information-allowed connection.")}},error:(t,_,n)=>{this._terminate_handshake(e.ws,"Unable to retrieve nonce from server",{status:_,error_string:n})}})}_terminate_handshake(e,t,_={}){const n={message:t,..._};this.logger.report_event("unity_failure",n),e&&e.close()}_is_connection_in_progress(e){return e===I.PENDING||e===I.RETRYING}add_on_open_callback(e){this._on_open_callbacks.push(e)}add_on_open_failed_callback(e){this._on_open_failed_callbacks.push(e)}add_on_close_callback(e){this._on_close_callbacks.push(e)}call_when_ready(e,t=null){return this.is_ready()?e():this._is_connection_in_progress(this._connection_state)?this._pending_callbacks.push({callback:e,error_callback:t}):t?t(a.CONNECTION_CLOSED):void 0}is_ready(){return this._webSocket&&this._webSocket.readyState===WebSocket.OPEN&&this._connection_state===I.ESTABLISHED}feature_supported(e,t=[]){return s.assert(null!==this._permission_level,"Connection is not ready."),!(null!==this.client_version&&this.client_version<e)&&t.includes(this._permission_level)}isUnityServerRunning(e){return new Promise((t=>{setTimeout((()=>t(!1)),e);for(let e=17600;e<=17602;e++){const _=new WebSocket(this._getWebSocketURI(e));_.onopen=function(){_.close(),t(!0)}}}))}}g.SECURE_PERMISSION=f.SECURE_PERMISSION,g.INSECURE_WEB_PERMISSION=f.INSECURE_WEB_PERMISSION,g.INSECURE_CLIENT_PERMISSION=f.INSECURE_CLIENT_PERMISSION,g.INSECURE_PERMISSION=f.INSECURE_PERMISSION;const R={_uc:new g,_has_handshake_started:!1,_cached_file_browser_display_name:null,_start_handshake_if_needed(){this._has_handshake_started||(this._uc.start(),this._has_handshake_started=!0)},continue_as_user(e,t,_,n=null){return this._start_handshake_if_needed(),this._uc.call_when_ready((()=>{if(this._uc.feature_supported(l.WEB_DESTINY,[g.INSECURE_WEB_PERMISSION]))return this._uc.logger.report_event("continue_as_user",{browser:e,refresh_token:t}),this._uc.send("continue_as_user",{browser:e,refresh_token:t},_,n)}),n)},continue_as_user_direct(e,t=null){return this._start_handshake_if_needed(),this._uc.call_when_ready((()=>{if(this._uc.feature_supported(l.WEB_DESTINY_V2,[g.INSECURE_WEB_PERMISSION]))return this._uc.logger.report_event("continue_as_user_direct"),this._uc.send("continue_as_user_direct",null,e,t)}),t)},web_destiny_info(e,t=null){return this._start_handshake_if_needed(),this._uc.call_when_ready((()=>{if(this._uc.feature_supported(l.WEB_DESTINY_V2,[g.INSECURE_WEB_PERMISSION]))return this._uc.logger.report_event("web_destiny_info"),this._uc.send("web_destiny_info",null,e,t)}),t)},client_supports_open_in_file_browser(){return this._uc.feature_supported(l.OPEN_IN_FILE_BROWSER,[g.SECURE_PERMISSION])},ensure_unity_ready(){return this._start_handshake_if_needed(),new Promise((e=>this._uc.call_when_ready((()=>{e(!0)}),(()=>{this._uc=new g,this._has_handshake_started=!1,e(!1)}))))},open_file(e,_,n,i,r=null,o=!1){this._start_handshake_if_needed();const a=this.server_path(e,_);return this._uc.call_when_ready((()=>{if(this._uc.feature_supported(l.UNITY_HANDSHAKE,[g.SECURE_PERMISSION])){this._uc.logger.report_event("open_file",{user_id:n,path_id:a,file_extension:t.file_extension(a),in_file_browser:o}),t.SilentBackgroundRequest$1({url:u(),data:{user_id:n,server_path:a,file_extension:t.file_extension(a),in_file_browser:o,unity_session_id:this._uc.logger.unity_session_id(),buildno:this._uc.logger._data.buildno,host_id:this._uc.logger._data.host_id}});const e={server_path:a,user_id:n};this._uc.client_version>=l.OPEN_IN_FILE_BROWSER?e.in_file_browser=o:s.assert(!o,"The connected client doesn't support opening in file browser."),this._uc.send("open_file",e,i,r)}}),r)},standard_open_file_handler(e){if(!e)return o.Notify.error(r.intl.formatMessage({id:"9HWjA9",defaultMessage:"Error opening file"}))},check_file(e,_,n,s,i=null){this._start_handshake_if_needed();const r=this.server_path(e,_),o=e=>{this._check_file_deprecated_on_client()&&(e={is_locally_available:e}),s(e)};this._uc.call_when_ready((()=>{if(this._uc.feature_supported(l.UNITY_HANDSHAKE,[g.SECURE_PERMISSION]))return this._uc.logger.report_event("check_file",{user_id:n,path_id:r,file_extension:t.file_extension(r)}),this._uc.send("check_file",{server_path:r,user_id:n},o,i)}),i)},add_on_ready_callback(e){return this._uc.call_when_ready(e)},check_file_batch(e,_,n,s=null){return new Promise(((i,r)=>{this._start_handshake_if_needed();const o=e.map((e=>this.server_path(e.ns_id,e.ns_path))),a=e=>{if(this._check_file_deprecated_on_client())for(const t in e){const _=e[t];e[t]={is_locally_available:_}}n&&n(e),i(e)},c=function(e){s&&s(e),r(e)};this._uc.call_when_ready((()=>{if(this._uc.feature_supported(l.UNITY_HANDSHAKE,[g.SECURE_PERMISSION]))return this._uc.logger.report_event("check_file_batch",{user_id:_,path_ids:o,file_extensions:o.map(t.file_extension)}),this._uc.send("check_file_batch",{server_paths:o,user_id:_},a,c)}),c)}))},file_browser_display_name(e,t=null){if(null!=this._cached_file_browser_display_name)return void e(this._cached_file_browser_display_name);const _=t=>(this._cached_file_browser_display_name=t,e(t));this._start_handshake_if_needed();return this._uc.call_when_ready((()=>this._uc.feature_supported(l.CHECK_FILE_RETURNS_OBJ,[g.SECURE_PERMISSION])?(this._uc.logger.report_event("file_browser_display_name"),this._uc.send("file_browser_display_name",null,_,t)):e(null)),t)},_check_file_deprecated_on_client(){return l.UNITY_HANDSHAKE<=this._uc.client_version&&this._uc.client_version<l.CHECK_FILE_RETURNS_OBJ},server_path:(e,t)=>`${e}:${t}`,has_chime(e,t=null){this._start_handshake_if_needed();return this._uc.call_when_ready((()=>{if(this._uc.feature_supported(l.CHIME_OPEN,[g.SECURE_PERMISSION]))return this._uc.logger.report_event("has_chime"),this._uc.send("has_chime",null,e,t)}),t)},open_chime(e,t,_=null){this._start_handshake_if_needed();return this._uc.call_when_ready((()=>{if(this._uc.feature_supported(l.CHIME_OPEN,[g.SECURE_PERMISSION]))return this._uc.logger.report_event("open_chime",{parameters:e}),this._uc.send("open_chime",e,t,_)}),_)},can_open_apollo(){return new Promise(((e,t)=>(this._start_handshake_if_needed(),this._uc.call_when_ready((()=>{this._uc.feature_supported(l.OPEN_COLLAB_BROWSE,[g.SECURE_PERMISSION,g.INSECURE_WEB_PERMISSION])&&this._uc.send("can_open_apollo",{},e,t)}),t))))},open_apollo_main_window(){return new Promise(((e,t)=>(this._start_handshake_if_needed(),this._uc.call_when_ready((()=>{this._uc.feature_supported(l.OPEN_COLLAB_BROWSE,[g.SECURE_PERMISSION,g.INSECURE_WEB_PERMISSION])&&this._uc.send("open_apollo_main_window",{},e,t)}),t))))},isUnityServerRunning(){return this._uc.isUnityServerRunning(200)},isUnitySupported:()=>p.web_sockets_supported()};e.UnityFeatures=R,e.WebSocketConfig=E}));
//# sourceMappingURL=c_unity_features.js-vfljtULfN.map

//# debugId=83145edc-6c25-37fe-97e3-26b8b2545d9d